<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Van Manager - Final Combined</title>
  <style>
    :root{ --line:#6d8fb0; --accent:#2c5282; --danger:#e53e3e; --bg:#ffffff; --success:#2f855a; }
    *{ box-sizing:border-box; }
    body{ 
      margin:0; font-family: Arial, sans-serif; background:#f6f7f9; 
      /* Allows vertical scrolling while preventing horizontal bounce */
      touch-action: pan-y; 
      overscroll-behavior: none; 
    }
    .plan-nav { display:flex; background:#fff; padding:10px 16px 0; border-bottom:2px solid #ddd; gap:5px; }
    .nav-tab { padding:10px 20px; border:1px solid #ddd; border-bottom:none; border-radius:8px 8px 0 0; cursor:pointer; font-weight:bold; }
    .nav-tab.active { background:var(--accent); color:#fff; }
    .page{ max-width:1200px; margin: 0 auto; padding: 16px; display:grid; gap:14px; }
    .topbar{ background:#fff; border-radius:10px; padding:14px; display:grid; gap:10px; }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"]{ flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
    button{ padding:10px 15px; border-radius:8px; border:1px solid #ccc; cursor:pointer; font-weight:bold; }
    .btn-submit { background:var(--danger); color:#fff; border:none; }
    .btn-pdf { background:var(--success); color:#fff; border:none; }
    .btn-share { background: #ebf8ff; border: 2px solid #3182ce; color: #2c5282; }
    .btn-fetch { background: #fffaf0; border: 2px solid #ed8936; color: #7b341e; }
    
    .tray-area { display:flex; gap:10px; min-height:80px; }
    .tiles-tray{ flex:1; display:flex; gap:10px; flex-wrap:wrap; padding:10px; border:2px dashed #cbd5e0; border-radius:8px; background:#f8fafc; }
    #bin { width:80px; display:flex; align-items:center; justify-content:center; background:#fed7d7; border:2px solid #feb2b2; border-radius:8px; color:#c53030; font-size:30px; }
    
    .tile, .tile-inbox { 
      background:#fff; border-radius:6px; display:flex; align-items:center; justify-content:center; 
      text-align:center; box-shadow:0 1px 2px rgba(0,0,0,0.12); cursor:grab; 
      /* Elements themselves prevent default touch to handle drag logic manually */
      touch-action: none; 
      user-select:none; z-index:100;
      word-break: break-word; line-height: 1.05; overflow: hidden;
    }
    .tile { min-width:110px; min-height:44px; padding:5px; border:1px solid #ddd; }
    .tile-inbox { width:100%; border:none !important; box-shadow: none !important; }
    .layout-card{ background:#fff; border-radius:10px; padding:14px; }
    .van-section { margin-bottom:30px; border-bottom:2px solid #edf2f7; padding-bottom:20px; }
    .card-title{ font-weight:bold; margin-bottom:12px; display:flex; justify-content:space-between; }
    .kennel-grid{ border:2px solid var(--line); background:#fff; display:grid; }
    .box{ border:2px solid var(--line); min-height:85px; position:relative; display:flex; align-items:center; justify-content:center; padding:22px 2px 2px 2px; }
    .stop-input{ position:absolute; top:4px; left:4px; width:38px; height:20px; border:1px solid #ccc; border-radius:4px; font-size:11px; text-align:center; z-index:5; }
    .box-inner{ width:100%; height:100%; display:flex; flex-direction:column; gap:6px; pointer-events:auto; justify-content: center; }
    .is-dragging { position:fixed; z-index:9999 !important; pointer-events:none; opacity:0.8; transform:scale(1.1); box-shadow:0 10px 20px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <div class="plan-nav">
    <div class="nav-tab active" data-plan="AM">AM Plan</div>
    <div class="nav-tab" data-plan="PM">PM Plan</div>
    <div class="nav-tab" data-plan="NEXT_AM">Next Day AM</div>
  </div>
  <div class="page">
    <div class="topbar">
      <div class="controls">
        <input id="tileText" type="text" placeholder="Dog Name..." />
        <button id="addTileBtn" type="button">Add Dog</button>
        <button id="shareBtn" class="btn-share">Share Plan</button>
        <button id="fetchBtn" class="btn-fetch">Fetch Cloud</button>
        <button id="pdfBtn" class="btn-pdf">PDF Export</button>
        <button id="clearBtn" class="btn-danger">Clear Local</button>
      </div>
      <div class="tray-area"><div class="tiles-tray" id="tray"></div><div id="bin">ðŸ—‘</div></div>
      <div id="syncTime" style="font-size: 11px; color: #718096; text-align: right;">Cloud Version: Never</div>
    </div>

    <div class="layout-card" id="printArea">
      <div class="van-section">
        <div class="card-title"><span>Big Van BV</span><span id="currentLabel">AM Plan</span></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)"><div class="box" data-box="bv-c1"></div><div class="box" data-box="bv-c2"></div><div class="box" data-box="bv-c3"></div></div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)"><div class="box" data-box="bv-c4"></div><div class="box" data-box="bv-c5"></div></div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)"><div class="box" data-box="bv-c6"></div><div class="box" data-box="bv-c7"></div></div>
          </div>
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)"><div class="box" data-box="bv-b1"></div><div class="box" data-box="bv-b2"></div><div class="box" data-box="bv-b3"></div></div>
            <div style="display:grid; grid-template-columns:repeat(3,1fr)"><div class="box" data-box="bv-b4"></div><div class="box" data-box="bv-b5"></div><div class="box" data-box="bv-b6"></div></div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)"><div class="box" data-box="bv-b7"></div><div class="box" data-box="bv-b8"></div></div>
          </div>
        </div>
      </div>

      <div class="van-section">
        <div class="card-title">Small Van SV</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)"><div class="box" data-box="sv-c1"></div><div class="box" data-box="sv-c2"></div><div class="box" data-box="sv-c3"></div></div>
          </div>
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(2,1fr)"><div class="box" data-box="sv-b1"></div><div class="box" data-box="sv-b2"></div></div>
          </div>
        </div>
      </div>

      <div class="van-section">
        <div class="card-title">Dispatch Van DV</div>
        <div style="display:grid; grid-template-columns: 1fr 2.2fr 1fr; gap:15px;">
          <div class="kennel-grid"><div class="box" data-box="dv-l1"></div><div class="box" data-box="dv-l2"></div></div>
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns: repeat(3,1fr)"><div class="box" data-box="dv-m1"></div><div class="box" data-box="dv-m2"></div><div class="box" data-box="dv-m3"></div></div>
            <div class="box" data-box="dv-m-xl" style="min-height:120px"></div>
          </div>
          <div class="kennel-grid"><div class="box" data-box="dv-r1"></div><div class="box" data-box="dv-r2"></div></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    (function(){
      // UPDATED URL
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbziGtajlb_S0Yqe-7WzylGXmx1jejEvkm1o9Zgk_UdSmrVrByIPQoXSIBgzpM_aUvpf/exec';
      const tray = document.getElementById('tray'), input = document.getElementById('tileText');
      const shareBtn = document.getElementById('shareBtn'), fetchBtn = document.getElementById('fetchBtn'), syncTimeEl = document.getElementById('syncTime');
      const STORAGE_PREFIX = 'van_v4_';
      
      let currentPlan = 'AM';
      let state = { tiles:{}, placements:{}, stops:{} };

      function localSave(){ 
        localStorage.setItem(STORAGE_PREFIX + currentPlan, JSON.stringify(state));
      }

      async function cloudFetch(){
        fetchBtn.textContent = "Fetching...";
        try {
          const res = await fetch(`${SCRIPT_URL}?planId=${currentPlan}`, {
            method: 'GET',
            cache: 'no-cache',
            redirect: 'follow' 
          });

          if (!res.ok) throw new Error("Network response was not ok");
          const cloud = await res.json();

          if (cloud && cloud.state && cloud.state !== "{}") {
            state = JSON.parse(cloud.state);
            syncTimeEl.textContent = `Cloud Version: ${cloud.time}`;
            localSave();
            hydrate();
            alert("Fetch Successful!");
          } else {
            alert("No cloud data found for this plan.");
          }
        } catch(e) { 
          console.error("Fetch Error:", e);
          alert("Fetch failed. Check deployment settings."); 
        } finally {
          fetchBtn.textContent = "Fetch Cloud";
        }
      }

      async function cloudShare(){
        shareBtn.textContent = "Sharing...";
        try {
          const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({action:'savePlan', state:state, planId:currentPlan}),
            redirect: 'follow'
          });
          const time = await res.text();
          syncTimeEl.textContent = `Cloud Version: ${time}`;
          alert("Plan Shared to Cloud!");
        } catch(e) { 
          alert("Sync failed."); 
        } finally {
          shareBtn.textContent = "Share Plan";
        }
      }

      function loadPlan(p){
        currentPlan = p;
        document.getElementById('currentLabel').textContent = p.replace('_', ' ') + ' Plan';
        const raw = localStorage.getItem(STORAGE_PREFIX + p);
        state = raw ? JSON.parse(raw) : {tiles:{}, placements:{}, stops:{}};
        hydrate();
      }

      let activeClone = null, dragId = null, startX, startY;

      function wirePointer(el, tid) {
        el.onpointerdown = (e) => {
          startX = e.clientX; startY = e.clientY;
          dragId = tid;
          el.setPointerCapture(e.pointerId);

          el.onpointermove = (m) => {
            if (Math.abs(m.clientX - startX) > 10 || Math.abs(m.clientY - startY) > 10) {
              if (!activeClone) {
                activeClone = el.cloneNode(true); activeClone.classList.add('is-dragging'); document.body.appendChild(activeClone);
                el.style.opacity = '0';
              }
              activeClone.style.left = (m.clientX-50)+'px'; activeClone.style.top = (m.clientY-20)+'px';
            }
          };

          el.onpointerup = (u) => {
            el.releasePointerCapture(u.pointerId); el.onpointermove = null; el.onpointerup = null; el.style.opacity = '1';
            if (activeClone) {
              const target = document.elementFromPoint(u.clientX, u.clientY);
              const box = target?.closest('.box'), bin = target?.closest('#bin');
              Object.keys(state.placements).forEach(k => state.placements[k] = state.placements[k].filter(id => id !== dragId));
              if (bin) { delete state.tiles[dragId]; }
              else if (box) { 
                if(!state.placements[box.dataset.box]) state.placements[box.dataset.box] = []; 
                if(state.placements[box.dataset.box].length < 2) state.placements[box.dataset.box].push(dragId); 
              }
              activeClone.remove(); activeClone = null; localSave(); hydrate();
            }
          };
        };
        el.ondblclick = () => { const n = prompt("Edit:", state.tiles[tid].text); if(n) { state.tiles[tid].text = n; localSave(); hydrate(); } };
      }

      function hydrate(){
        tray.innerHTML = '';
        document.querySelectorAll('.box').forEach(box => {
          box.innerHTML = '';
          const stop = document.createElement('input'); stop.className = 'stop-input'; 
          stop.value = state.stops[box.dataset.box] || '';
          stop.oninput = () => { state.stops[box.dataset.box] = stop.value; localSave(); };
          box.appendChild(stop);
          const inner = document.createElement('div'); inner.className = 'box-inner'; box.appendChild(inner);
          const ids = state.placements[box.dataset.box] || [];
          inner.classList.toggle('two', ids.length === 2);
          inner.classList.toggle('one', ids.length === 1);
          ids.forEach(id => { if(state.tiles[id]) { const t = document.createElement('div'); t.className = 'tile-inbox'; t.textContent = state.tiles[id].text; wirePointer(t, id); inner.appendChild(t); fitText(t); } });
        });
        const placed = new Set(); Object.values(state.placements).forEach(a => a.forEach(id => placed.add(id)));
        Object.keys(state.tiles).forEach(id => { if(!placed.has(id)) { const t = document.createElement('div'); t.className = 'tile'; t.textContent = state.tiles[id].text; wirePointer(t, id); tray.appendChild(t); fitText(t); } });
      }

      function fitText(node, isExport = false){
        if(!node.clientWidth) return;
        let lo = 10, hi = isExport ? 160 : 100, best = 14;
        while(lo <= hi){
          let mid = Math.floor((lo+hi)/2); node.style.fontSize = mid+'px';
          if(node.scrollWidth <= (node.clientWidth-6) && node.scrollHeight <= (node.clientHeight-6)){ best = mid; lo = mid+1; }
          else hi = mid-1;
        }
        node.style.fontSize = best+'px';
      }

      document.getElementById('addTileBtn').onclick = () => { 
        const t = input.value.trim(); if(!t) return; 
        const id = 't_'+Date.now(); state.tiles[id] = {id, text:t}; 
        input.value = ''; localSave(); hydrate(); 
      };
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('addTileBtn').click(); });
      
      shareBtn.onclick = cloudShare;
      fetchBtn.onclick = cloudFetch;
      
      document.getElementById('clearBtn').onclick = () => { if(confirm("Clear local only?")) { state={tiles:{}, placements:{}, stops:{}}; localSave(); hydrate(); } };
      document.querySelectorAll('.nav-tab').forEach(t => t.onclick = () => { document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active')); t.classList.add('active'); loadPlan(t.dataset.plan); });
      
      loadPlan('AM');
    })();
  </script>
</body>
</html>
