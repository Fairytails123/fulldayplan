<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Van Manager - V4</title>
  <style>
    :root { 
      --line: #6d8fb0; 
      --accent: #2c5282; 
      --danger: #e53e3e; 
      --bg: #ffffff; 
      --success: #2f855a;
      --warning: #ed8936;
      --info: #3182ce;
      --secondary: #9f7aea;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --radius: 10px;
    }
    
    * { box-sizing: border-box; }
    
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
      background: #f6f7f9; 
      touch-action: pan-x pan-y;
      overscroll-behavior: none;
      min-height: 100vh;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Body lock during drag - NO position:fixed (causes visual jump) */
    body.is-dragging {
      overflow: hidden !important;
      touch-action: none !important;
    }
    
    /* Navigation Tabs */
    .plan-nav { 
      display: flex; 
      background: #fff; 
      padding: 12px 16px 0; 
      border-bottom: 2px solid #ddd; 
      gap: 6px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    
    .nav-tab { 
      padding: 12px 24px; 
      border: 1px solid #ddd; 
      border-bottom: none; 
      border-radius: 8px 8px 0 0; 
      cursor: pointer; 
      font-weight: 600;
      background: #f8fafc;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      font-size: 14px;
    }
    
    /* Hover states - only for mouse devices */
    @media (hover: hover) and (pointer: fine) {
      .nav-tab:hover:not(.active) { 
        background: #e2e8f0; 
      }
    }
    
    .nav-tab.active { 
      background: var(--accent); 
      color: #fff;
      border-color: var(--accent);
    }
    
    /* Main Layout */
    .page { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 16px; 
      display: grid; 
      gap: 16px; 
    }
    
    /* Top Controls */
    .topbar { 
      background: #fff; 
      border-radius: var(--radius); 
      padding: 16px; 
      display: grid; 
      gap: 12px;
      box-shadow: var(--shadow);
    }
    
    .controls { 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      align-items: center; 
    }
    
    .input-group {
      display: flex;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }
    
    input[type="text"] { 
      flex: 1; 
      padding: 12px 14px; 
      border-radius: 8px; 
      border: 2px solid #e2e8f0; 
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.15);
    }
    
    /* Buttons */
    button { 
      padding: 12px 18px; 
      border-radius: 8px; 
      border: 2px solid transparent; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 14px;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      white-space: nowrap;
    }
    
    @media (hover: hover) and (pointer: fine) {
      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-primary { 
      background: var(--accent); 
      color: #fff; 
    }
    
    @media (hover: hover) and (pointer: fine) {
      .btn-primary:hover:not(:disabled) {
        background: #1e4072;
      }
    }
    
    .btn-danger { 
      background: #fff5f5; 
      border-color: var(--danger); 
      color: var(--danger); 
    }
    
    @media (hover: hover) and (pointer: fine) {
      .btn-danger:hover:not(:disabled) {
        background: var(--danger);
        color: #fff;
      }
    }
    
    .btn-share { 
      background: #ebf8ff; 
      border-color: var(--info); 
      color: var(--accent); 
    }
    
    @media (hover: hover) and (pointer: fine) {
      .btn-share:hover:not(:disabled) {
        background: var(--info);
        color: #fff;
      }
    }
    
    .btn-fetch { 
      background: #fffaf0; 
      border-color: var(--warning); 
      color: #7b341e; 
    }
    
    @media (hover: hover) and (pointer: fine) {
      .btn-fetch:hover:not(:disabled) {
        background: var(--warning);
        color: #fff;
      }
    }
    
    .btn-transmit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-size: 15px;
    }
    
    @media (hover: hover) and (pointer: fine) {
      .btn-transmit:hover:not(:disabled) {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }
    }
    
    .btn-transmit.success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }
    
    .btn-transmit.transmitting {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Tray Area */
    .tray-area { 
      display: flex; 
      gap: 12px; 
      min-height: 90px; 
    }
    
    .tiles-tray { 
      flex: 1; 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      padding: 12px; 
      border: 2px dashed #cbd5e0; 
      border-radius: 8px; 
      background: #f8fafc;
      align-content: flex-start;
      min-height: 80px;
      transition: border-color 0.2s, background-color 0.2s;
    }
    
    .tiles-tray.drag-over {
      border-color: var(--accent);
      background: #ebf8ff;
    }
    
    .tiles-tray:empty::after {
      content: "Drag dogs here or add new ones above";
      color: #a0aec0;
      font-style: italic;
      align-self: center;
      width: 100%;
      text-align: center;
    }
    
    #bin { 
      width: 80px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: #fed7d7; 
      border: 2px dashed #fc8181; 
      border-radius: 8px; 
      color: #c53030; 
      font-size: 32px;
      transition: background-color 0.2s, border-color 0.2s;
    }
    
    #bin::after {
      content: "";
    }
    
    #bin.drag-over {
      background: #c53030;
      border-style: solid;
    }
    
    #bin.drag-over::after {
      content: "";
    }
    
    /* Tiles */
    .tile, .tile-inbox { 
      background: #fff; 
      border-radius: 6px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      text-align: center; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      cursor: grab; 
      touch-action: none; /* Needed for pointer capture to work */
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      z-index: 100;
      word-break: break-word; 
      line-height: 1.1; 
      overflow: hidden;
      transition: box-shadow 0.2s, border-color 0.2s;
      font-weight: 500;
      position: relative;
    }
    
    /* Long-press visual feedback (Android only) */
    .tile.long-press-active,
    .tile-inbox.long-press-active {
      background: #ebf8ff;
      border-color: var(--accent) !important;
    }
    
    /* Hover states - only for mouse devices */
    @media (hover: hover) and (pointer: fine) {
      .tile:hover, .tile-inbox:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
    }
    
    .tile { 
      min-width: 110px; 
      min-height: 48px; 
      padding: 8px 10px; 
      border: 2px solid #e2e8f0;
    }
    
    .tile-inbox { 
      width: 100%; 
      min-height: 32px;
      padding: 4px 6px;
      border: 1px solid #e2e8f0;
      background: linear-gradient(135deg, #fff 0%, #f7fafc 100%);
    }
    
    /* Layout Cards */
    .layout-card { 
      background: #fff; 
      border-radius: var(--radius); 
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .van-section { 
      margin-bottom: 28px; 
      border-bottom: 2px solid #edf2f7; 
      padding-bottom: 24px; 
    }
    
    .van-section:last-child {
      margin-bottom: 0;
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .card-title { 
      font-weight: 700; 
      margin-bottom: 14px; 
      display: flex; 
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #2d3748;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .dog-count {
      background: #edf2f7;
      color: #4a5568;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .dog-count.has-dogs {
      background: #c6f6d5;
      color: var(--success);
    }
    
    /* Departure Time Selector - Only for NEXT_AM */
    .departure-selector {
      display: none;
      align-items: center;
      gap: 8px;
      background: #f0fff4;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #9ae6b4;
    }
    
    .departure-selector label {
      font-size: 13px;
      font-weight: 600;
      color: #276749;
    }
    
    .departure-selector select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #68d391;
      background: #fff;
      font-size: 13px;
      font-weight: 600;
      color: #276749;
      cursor: pointer;
    }
    
    .departure-selector select:focus {
      outline: none;
      border-color: #38a169;
      box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.3);
    }
    
    body.next-am-mode .departure-selector {
      display: flex;
    }
    
    /* Grid Layouts */
    .two-cols { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px; 
    }
    
    .kennel-grid { 
      border: 2px solid var(--line); 
      background: #fff; 
      display: grid;
      border-radius: 6px;
      overflow: visible;
    }
    
    .box { 
      border: 2px solid var(--line); 
      min-height: 105px; 
      position: relative; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 40px 4px 4px 4px;
      background: #fff;
      transition: background-color 0.2s, border-color 0.2s;
      overflow: visible;
    }
    
    .box.drag-over {
      background: #ebf8ff;
      border-color: var(--accent);
    }
    
    .box.full {
      background: #f0fff4;
    }
    
    /* Stop Number Inputs */
    .stop-input { 
      position: absolute; 
      top: 3px; 
      left: 3px; 
      width: 50px;
      height: 30px; 
      border: 2px solid #cbd5e0; 
      border-radius: 5px; 
      font-size: 18px; 
      text-align: center; 
      z-index: 5;
      font-weight: 700;
      background: #fff;
      color: #2d3748;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      box-sizing: border-box;
      padding: 2px 4px;
      margin: 0;
      line-height: 1;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: visible;
      text-overflow: clip;
      white-space: nowrap;
    }
    
    .stop-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(44, 82, 130, 0.2);
    }
    
    /* Secondary stop input - top right, purple border */
    .stop-input-secondary {
      position: absolute;
      top: 3px;
      right: 3px;
      left: auto;
      width: 50px;
      height: 30px;
      border: 2px solid var(--secondary);
      border-radius: 5px;
      font-size: 18px;
      text-align: center;
      z-index: 5;
      font-weight: 700;
      background: #faf5ff;
      color: #553c9a;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      box-sizing: border-box;
      padding: 2px 4px;
      margin: 0;
      line-height: 1;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: visible;
      text-overflow: clip;
      white-space: nowrap;
    }
    
    .stop-input-secondary:focus {
      outline: none;
      border-color: #805ad5;
      box-shadow: 0 0 0 2px rgba(159, 122, 234, 0.3);
    }
    
    .stop-input-secondary::placeholder {
      color: #b794f4;
    }
    
    .box-inner { 
      width: 100%; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
      pointer-events: auto; 
      justify-content: center;
    }
    
    .box-inner.two {
      gap: 3px;
    }
    
    .box-inner.two .tile-inbox {
      min-height: 28px;
      font-size: 13px;
    }
    
    /* Wheel Arch Styling */
    .box.has-wheel-arch {
      padding-bottom: 32px;
      position: relative;
    }
    
    .wheel-arch {
      position: absolute;
      bottom: 4px;
      width: 50px;
      height: 24px;
      background: #fff;
      border: 2px solid var(--line);
      border-radius: 50px 50px 0 0;
      border-bottom: none;
    }
    
    .wheel-arch.left {
      left: 8px;
    }
    
    .wheel-arch.right {
      right: 8px;
    }
    
    .wheel-arch.center {
      left: 50%;
      transform: translateX(-50%);
    }
    
    /* Dragging State - NO rotate (causes "twisted" appearance) */
    .is-dragging { 
      position: fixed; 
      z-index: 9999 !important; 
      pointer-events: none; 
      opacity: 0.9; 
      transform: scale(1.05); /* Subtle scale only, NO rotate */
      box-shadow: 0 15px 35px rgba(0,0,0,0.25);
      touch-action: none;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      padding: 14px 20px;
      border-radius: 8px;
      color: #fff;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
      max-width: 320px;
    }
    
    .toast-success { background: var(--success); }
    .toast-error { background: var(--danger); }
    .toast-info { background: var(--info); }
    .toast-warning { background: var(--warning); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; transform: translateX(50%); }
    }
    
    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #718096;
      padding-top: 8px;
      border-top: 1px solid #edf2f7;
      margin-top: 8px;
    }
    
    .status-bar .online-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    
    .status-dot.offline {
      background: var(--danger);
    }
    
    /* Responsive - Tablet */
    @media (max-width: 900px) { 
      .two-cols { grid-template-columns: 1fr; }
      .controls { flex-direction: column; align-items: stretch; }
      .input-group { min-width: 100%; }
      .btn-group { display: flex; flex-wrap: wrap; gap: 8px; }
      .btn-group button { flex: 1; min-width: calc(50% - 4px); }
      .card-title { flex-direction: column; align-items: flex-start; }
    }
    
    /* Responsive - Mobile */
    @media (max-width: 600px) {
      html, body {
        overflow-x: hidden;
        width: 100%;
      }
      
      .plan-nav { 
        padding: 8px 12px 0; 
        gap: 6px; 
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .nav-tab { 
        padding: 12px 18px; 
        font-size: 14px; 
        flex-shrink: 0;
      }
      
      .page { 
        padding: 10px; 
        gap: 10px;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      .topbar, .layout-card { 
        padding: 12px;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      input[type="text"] {
        padding: 12px 14px;
        font-size: 16px;
      }
      
      .btn-group { 
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 100%;
      }
      
      .btn-group button { 
        padding: 10px 12px;
        font-size: 13px;
        min-height: 42px;
        width: 100%;
      }
      
      .btn-transmit {
        grid-column: 1 / -1;
        padding: 12px 20px;
        font-size: 15px;
        min-height: 46px;
      }
      
      .tray-area { min-height: 100px; }
      .tiles-tray { 
        min-height: 90px; 
        padding: 10px;
        gap: 10px;
      }
      
      .tile { 
        min-width: 90px; 
        min-height: 46px; 
        padding: 8px 10px;
        font-size: 14px;
      }
      
      #bin { 
        width: 70px; 
        font-size: 32px;
      }
      
      .box { 
        min-height: 95px; 
        padding-top: 38px; 
      }
      
      .tile-inbox {
        min-height: 34px;
        padding: 5px 6px;
        font-size: 13px;
      }
      
      .box-inner.two .tile-inbox {
        min-height: 28px;
        font-size: 12px;
      }
      
      .stop-input, .stop-input-secondary { 
        width: 50px !important; 
        height: 30px !important; 
        font-size: 18px !important;
        padding: 2px 4px !important;
      }
      
      .van-section {
        margin-bottom: 16px;
        padding-bottom: 16px;
      }
      
      .card-title {
        font-size: 15px;
        gap: 10px;
      }
      
      .dog-count {
        font-size: 12px;
        padding: 4px 10px;
      }
      
      .departure-selector {
        padding: 6px 10px;
      }
      
      .departure-selector select {
        padding: 8px 10px;
        font-size: 14px;
      }
      
      .van-section[data-van="dv"] > div {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }
      
      .van-section[data-van="dv"] .kennel-grid {
        width: 100%;
      }
      
      .van-section[data-van="dv"] .box[data-box="dv-m-xl"] {
        min-height: 95px !important;
      }
      
      .status-bar {
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
        padding-top: 10px;
        margin-top: 10px;
        font-size: 11px;
      }
      
      .kennel-grid {
        max-width: 100%;
      }
      
      .two-cols {
        gap: 12px;
      }
    }
    
    /* Responsive - Small phones */
    @media (max-width: 400px) {
      .plan-nav { padding: 6px 8px 0; }
      .nav-tab { padding: 10px 14px; font-size: 13px; }
      .page { padding: 8px; }
      .topbar, .layout-card { padding: 10px; }
      
      .tile { min-width: 80px; min-height: 42px; }
      .box { min-height: 90px; padding-top: 36px; }
      
      .stop-input, .stop-input-secondary { 
        width: 46px !important; 
        height: 28px !important; 
        font-size: 16px !important;
      }
    }
    
    /* Touch device optimisations */
    @media (pointer: coarse) {
      .tile, .tile-inbox {
        cursor: pointer;
      }
      
      .tile, .tile-inbox, .box {
        -webkit-user-select: none;
        user-select: none;
      }
      
      button:active {
        transform: scale(0.98);
      }
    }
    
    /* Print Styles */
    @media print {
      body { background: #fff !important; }
      .plan-nav, .topbar, .toast-container { display: none !important; }
      .page { max-width: 100%; padding: 0; }
      .layout-card { box-shadow: none; padding: 10px; }
      .van-section { page-break-inside: avoid; }
      .box { border-width: 1px; }
      .tile-inbox { border: 1px solid #999 !important; }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  
  <div class="plan-nav">
    <div class="nav-tab active" data-plan="PM">üåÜ PM Plan</div>
    <div class="nav-tab" data-plan="NEXT_AM">üìÖ Next Day AM</div>
  </div>
  
  <div class="page">
    <div class="topbar">
      <div class="controls">
        <div class="input-group">
          <input id="tileText" type="text" placeholder="Enter dog name..." maxlength="50" />
          <button id="addTileBtn" type="button" class="btn-primary">+ Add Dog</button>
        </div>
        <div class="btn-group">
          <button id="transmitBtn" class="btn-transmit" title="Transmit plan to Telegram">üöÄ Transmit Plan</button>
          <button id="shareBtn" class="btn-share">‚òÅÔ∏è Share</button>
          <button id="fetchBtn" class="btn-fetch">üì• Fetch</button>
          <button id="clearBtn" class="btn-danger">üóë Clear</button>
        </div>
      </div>
      <div class="tray-area">
        <div class="tiles-tray" id="tray"></div>
        <div id="bin">üóë</div>
      </div>
      <div class="status-bar">
        <div class="online-indicator">
          <span class="status-dot" id="statusDot"></span>
          <span id="onlineStatus">Online</span>
        </div>
        <div id="syncTime">Cloud: Never synced</div>
      </div>
    </div>

    <div class="layout-card" id="printArea">
      
      <div class="van-section" data-van="bv">
        <div class="card-title">
          <span>üöê Big Van (BV)</span>
          <div class="departure-selector" data-van="bv">
            <label>Departs:</label>
            <select id="bv-departure">
              <option value="07:15 am">07:15 am</option>
              <option value="07:30 am" selected>07:30 am</option>
              <option value="08:00 am">08:00 am</option>
              <option value="08:30 am">08:30 am</option>
              <option value="09:00 am">09:00 am</option>
              <option value="09:30 am">09:30 am</option>
            </select>
          </div>
          <span id="currentLabel" style="color: var(--accent);">PM Plan</span>
          <span class="dog-count" id="bv-count">0 dogs</span>
        </div>
        <div class="two-cols">
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)">
              <div class="box" data-box="bv-c1"></div>
              <div class="box" data-box="bv-c2"></div>
              <div class="box" data-box="bv-c3"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="bv-c4"></div>
              <div class="box" data-box="bv-c5"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="bv-c6"></div>
              <div class="box" data-box="bv-c7"></div>
            </div>
          </div>
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)">
              <div class="box" data-box="bv-b1"></div>
              <div class="box" data-box="bv-b2"></div>
              <div class="box" data-box="bv-b3"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box has-wheel-arch" data-box="bv-b4"></div>
              <div class="box" data-box="bv-b5"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="bv-b6"></div>
              <div class="box" data-box="bv-b7"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="van-section" data-van="sv">
        <div class="card-title">
          <span>üöó Small Van (SV)</span>
          <div class="departure-selector" data-van="sv">
            <label>Departs:</label>
            <select id="sv-departure">
              <option value="07:15 am">07:15 am</option>
              <option value="07:30 am" selected>07:30 am</option>
              <option value="08:00 am">08:00 am</option>
              <option value="08:30 am">08:30 am</option>
              <option value="09:00 am">09:00 am</option>
              <option value="09:30 am">09:30 am</option>
            </select>
          </div>
          <span class="dog-count" id="sv-count">0 dogs</span>
        </div>
        <div class="two-cols">
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="sv-c1"></div>
              <div class="box" data-box="sv-c2"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="sv-c3"></div>
              <div class="box" data-box="sv-c4"></div>
            </div>
          </div>
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="sv-b1"></div>
              <div class="box" data-box="sv-b2"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="sv-b3"></div>
              <div class="box has-wheel-arch" data-box="sv-b4"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="van-section" data-van="dv">
        <div class="card-title">
          <span>üöô Dispatch Van (DV)</span>
          <div class="departure-selector" data-van="dv">
            <label>Departs:</label>
            <select id="dv-departure">
              <option value="07:15 am">07:15 am</option>
              <option value="07:30 am" selected>07:30 am</option>
              <option value="08:00 am">08:00 am</option>
              <option value="08:30 am">08:30 am</option>
              <option value="09:00 am">09:00 am</option>
              <option value="09:30 am">09:30 am</option>
            </select>
          </div>
          <span class="dog-count" id="dv-count">0 dogs</span>
        </div>
        <div style="display:grid; grid-template-columns: 1fr auto; gap:20px; align-items:start;">
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="dv-c1"></div>
              <div class="box" data-box="dv-c2"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="dv-b1"></div>
              <div class="box" data-box="dv-b2"></div>
            </div>
          </div>
          <div class="kennel-grid" style="width:150px;">
            <div class="box" data-box="dv-m-xl" style="min-height:200px;"></div>
          </div>
        </div>
      </div>
      
    </div>
  </div>

  <script>
    (function(){
      // Configuration
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUeIiIJQZZeoo3aXHDdqVZNNqFKLhWhi_WhPVb6GUIvkMlfNxTKsOXyCTGdvAEsMLC/exec';
      const STORAGE_PREFIX = 'van_v5_';
      const MAX_UNDO_STATES = 20;
      
      // Detect Android Chrome (needs special touch handling)
      const isAndroid = /Android/i.test(navigator.userAgent);
      const LONG_PRESS_DELAY = 300;  // ms
      const MOVE_THRESHOLD = 10;     // px
      
      // Valid dog names from JotForm
      const VALID_DOG_NAMES = [
        "Aldo","Alfie","April","Argo","Arlo","Banjo","Barney Homewood","Barney Leeming","Baron","Bay","Beano","Bella","Belle","Benson","Betsy","Blue","Bluey","Bo","Bonnie Gallagher","Bonnie Lockwood","Bramble","Branko","Bruce","Bruno","Buddy Dann","Buddy Dargan","Buddy Selby","Casper Hamilton","Casper Kukreja","Che","Chester","Chloe","Clifford","Daisy Cremin","Daisy Parsons","Darcy Campbell","Darcy Dunn","Darwin","Delphine","Dexter","Dicee","Diego Gonsavles","Diego Wojcik","Dierdra","Digby","Dolly","Dottie","Dougie","Dudley","Dusty","Echo","Eddie","Effie","Enzo","Fenton","Ferox","Flaco","Fletcher","Florence","Freddie","Fredo","Frida Walsh","George Elliston","George Jackson","George Mohammed","Gina","Goldie","Haggis","Hattie Campbell","Hattie Duncan","Henry","Holly","Hugo","Incy","Ivy","Jack","Jeff","Jessie","Keti","Kip","Koji","Leo","Lily","Lola Bowles","Lola Fenloni","Lola Hall","Luke","Luna Crockford","Luna Grimshaw","Mac","Macy","Maggie","Margo","Marli","Marloe","Marlow","Martha","Max Tigwell","Merlin Crowley","Merlin Mayne","Miles","Miley","Millie Bowles","Millie Carter","Millie Cartwright","Millie Ellis","Milo McVey","Missy Evans","Mocha Gasper","Mocha Kolumbajew","Mochi","Moka","Mollie","Mos Wan","Moss Harris","Naira","Nala Sands","Nala Warnes","Narla Tester","Ned","Nevis","Nina","Obie","Oliver","Otis","Peggy Gibbons","Peggy Lucas","Pepper","Petch","Pippin","Pluto","Poppy Clark","Poppy Lancaster","Poppy Lass","Poppy Pike","Ralph Goddard","Raven","Reggie Daly","Reggie Foreman","Reggie Russel","Rex","Rita","River","Rocco","Roman","Roxy","Ruby Brooker","Ruby Favell","Ruby Jones","Rudy","Ruffles","Rufus","Rupy","Sam","Sebastian","Shadow Podkalicka","Shadow Wightman","Snoopy","Sonny","Sophie","Stanley James","Star","Storm","Tallulah","Tam","Tasha","Ted Lambie","Teddy Brown","Teddy Jamison","Terry","Tilly Mills","Tokyo","Warwick","Winnie Awele","Winnie Evans","Winnie Hall","Winnie Lancaster","Winnie Ryan","Woody Johns","Woody Warren","Zero","Ziggy"
      ];
      
      // Alias map
      const DOG_ALIASES = {
        "millie ct": "Millie Cartwright",
        "millie ca": "Millie Carter",
        "millie b": "Millie Bowles",
        "millie e": "Millie Ellis",
        "buddy d": "Buddy Dann",
        "buddy da": "Buddy Dargan",
        "buddy dr": "Buddy Dargan",
        "buddy s": "Buddy Selby",
        "teddy b": "Teddy Brown",
        "teddy j": "Teddy Jamison",
        "missy e": "Missy Evans",
        "milo m": "Milo McVey",
        "luna c": "Luna Crockford",
        "luna g": "Luna Grimshaw",
        "poppy c": "Poppy Clark",
        "poppy l": "Poppy Lancaster",
        "poppy la": "Poppy Lass",
        "poppy p": "Poppy Pike",
        "winnie a": "Winnie Awele",
        "winnie e": "Winnie Evans",
        "winnie h": "Winnie Hall",
        "winnie l": "Winnie Lancaster",
        "winnie r": "Winnie Ryan",
        "woody j": "Woody Johns",
        "woody w": "Woody Warren",
        "ruby b": "Ruby Brooker",
        "ruby f": "Ruby Favell",
        "ruby j": "Ruby Jones",
        "reggie d": "Reggie Daly",
        "reggie f": "Reggie Foreman",
        "reggie r": "Reggie Russel",
        "lola b": "Lola Bowles",
        "lola f": "Lola Fenloni",
        "lola h": "Lola Hall",
        "george e": "George Elliston",
        "george j": "George Jackson",
        "george m": "George Mohammed",
        "daisy c": "Daisy Cremin",
        "daisy p": "Daisy Parsons",
        "darcy c": "Darcy Campbell",
        "darcy d": "Darcy Dunn",
        "hattie c": "Hattie Campbell",
        "hattie d": "Hattie Duncan",
        "casper h": "Casper Hamilton",
        "casper k": "Casper Kukreja",
        "barney h": "Barney Homewood",
        "barney l": "Barney Leeming",
        "bonnie g": "Bonnie Gallagher",
        "bonnie l": "Bonnie Lockwood",
        "diego g": "Diego Gonsavles",
        "diego w": "Diego Wojcik",
        "merlin c": "Merlin Crowley",
        "merlin m": "Merlin Mayne",
        "mocha g": "Mocha Gasper",
        "mocha k": "Mocha Kolumbajew",
        "nala s": "Nala Sands",
        "nala w": "Nala Warnes",
        "peggy g": "Peggy Gibbons",
        "peggy l": "Peggy Lucas",
        "shadow p": "Shadow Podkalicka",
        "shadow w": "Shadow Wightman"
      };
      
      // DOM Elements
      const tray = document.getElementById('tray');
      const input = document.getElementById('tileText');
      const shareBtn = document.getElementById('shareBtn');
      const fetchBtn = document.getElementById('fetchBtn');
      const clearBtn = document.getElementById('clearBtn');
      const transmitBtn = document.getElementById('transmitBtn');
      const syncTimeEl = document.getElementById('syncTime');
      const statusDot = document.getElementById('statusDot');
      const onlineStatus = document.getElementById('onlineStatus');
      
      // State
      let currentPlan = 'PM';
      let state = { tiles: {}, placements: {}, stops: {}, departures: {} };
      
      let undoStack = [];
      let activeClone = null;
      let dragId = null;
      let startX, startY;
      let transmitComplete = false;
      let isDragging = false;
      
      // Android-specific touch state
      let longPressTimer = null;
      let touchStartPos = null;
      let currentDragElement = null;

      // ==================== TOAST NOTIFICATIONS ====================
      function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // ==================== ONLINE STATUS ====================
      function updateOnlineStatus() {
        const online = navigator.onLine;
        statusDot.classList.toggle('offline', !online);
        onlineStatus.textContent = online ? 'Online' : 'Offline';
        shareBtn.disabled = !online;
        fetchBtn.disabled = !online;
        if (!transmitComplete) {
          transmitBtn.disabled = !online;
        }
      }
      
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();

      // ==================== UNDO FUNCTIONALITY ====================
      function saveUndoState() {
        undoStack.push(JSON.stringify(state));
        if (undoStack.length > MAX_UNDO_STATES) {
          undoStack.shift();
        }
      }

      // ==================== LOCAL STORAGE ====================
      function localSave() { 
        try {
          localStorage.setItem(STORAGE_PREFIX + currentPlan, JSON.stringify(state));
        } catch (e) {
          showToast('Storage full! Please clear some data.', 'error');
        }
      }
      
      function localLoad() {
        try {
          const data = localStorage.getItem(STORAGE_PREFIX + currentPlan);
          if (data) {
            const parsed = JSON.parse(data);
            state.tiles = parsed.tiles || {};
            state.placements = parsed.placements || {};
            state.stops = parsed.stops || {};
            state.departures = parsed.departures || {};
          }
        } catch (e) {
          showToast('Error loading saved data', 'error');
        }
      }

      // ==================== STOP NUMBER HELPERS ====================
      function getStopObj(boxId) {
        if (!state.stops) state.stops = {};
        if (!state.stops[boxId]) state.stops[boxId] = { primary: '', secondary: '' };
        
        if (typeof state.stops[boxId] === 'string') {
          state.stops[boxId] = { primary: state.stops[boxId], secondary: '' };
        }
        return state.stops[boxId];
      }
      
      function setStopValue(boxId, which, value) {
        if (!state.stops) state.stops = {};
        if (!state.stops[boxId] || typeof state.stops[boxId] === 'string') {
          state.stops[boxId] = { primary: '', secondary: '' };
        }
        state.stops[boxId][which] = value;
        localSave();
      }
      
      function migrateStopsFormat() {
        if (!state.stops) return;
        Object.keys(state.stops).forEach(boxId => {
          if (typeof state.stops[boxId] === 'string') {
            state.stops[boxId] = { primary: state.stops[boxId], secondary: '' };
          }
        });
      }

      // ==================== CLOUD SYNC ====================
      // Updated to match Google Apps Script API format
      
      async function cloudShare() {
        shareBtn.disabled = true;
        shareBtn.textContent = '‚è≥ Saving...';
        
        try {
          // Google Apps Script expects: { action: 'savePlan', planId, state }
          const payload = {
            action: 'savePlan',
            planId: currentPlan,
            state: state  // The full state object
          };
          
          const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
          });
          
          // Google Apps Script returns plain text timestamp on success
          const responseText = await res.text();
          
          if (responseText && !responseText.includes('Error')) {
            syncTimeEl.textContent = 'Cloud: ' + responseText;
            showToast('Saved to cloud!', 'success');
          } else {
            throw new Error(responseText || 'Save failed');
          }
        } catch (err) {
          showToast('Save failed: ' + err.message, 'error');
        } finally {
          shareBtn.disabled = !navigator.onLine;
          shareBtn.textContent = '‚òÅÔ∏è Share';
        }
      }
      
      async function cloudFetch() {
        fetchBtn.disabled = true;
        fetchBtn.textContent = '‚è≥ Loading...';
        
        try {
          // Google Apps Script expects: ?planId=PM (not ?action=load&plan=PM)
          const res = await fetch(`${SCRIPT_URL}?planId=${currentPlan}`, {
            method: 'GET',
            mode: 'cors'
          });
          
          const result = await res.json();
          
          // Google Apps Script returns: { state: "{...json...}", time: "timestamp" }
          if (result.state && result.state !== '{}') {
            saveUndoState();
            
            // Parse the state JSON string
            const loadedState = typeof result.state === 'string' 
              ? JSON.parse(result.state) 
              : result.state;
            
            state.tiles = loadedState.tiles || {};
            state.placements = loadedState.placements || {};
            state.stops = loadedState.stops || {};
            state.departures = loadedState.departures || {};
            migrateStopsFormat();
            localSave();
            hydrate();
            
            syncTimeEl.textContent = 'Cloud: ' + (result.time || 'Unknown');
            showToast('Loaded from cloud!', 'success');
          } else if (result.error) {
            throw new Error(result.error);
          } else {
            showToast('No cloud data found', 'info');
          }
        } catch (err) {
          showToast('Load failed: ' + err.message, 'error');
        } finally {
          fetchBtn.disabled = !navigator.onLine;
          fetchBtn.textContent = 'üì• Fetch';
        }
      }

      // ==================== TRANSMIT PLAN ====================
      // Updated to match Google Apps Script transmitPlan format
      
      // Van name mapping - Google Apps Script expects full names
      const VAN_NAMES = {
        'bv': 'Big van - Transit',
        'sv': 'Small van - Renault',
        'dv': 'Dispatch van - Citroen'
      };
      
      async function transmitPlan() {
        if (transmitComplete) {
          showToast('Plan already transmitted. Clear to start fresh.', 'info');
          return;
        }
        
        transmitBtn.disabled = true;
        transmitBtn.classList.add('transmitting');
        transmitBtn.textContent = 'üì° Transmitting...';
        
        try {
          // Google Apps Script expects: { action: 'transmitPlan', dogs: [...], departures, planType }
          const dogs = [];
          const departures = state.departures || {};
          
          Object.entries(state.placements).forEach(([boxId, dogIds]) => {
            const vanPrefix = boxId.split('-')[0]; // 'bv', 'sv', or 'dv'
            const stopObj = getStopObj(boxId);
            const departureTime = departures[vanPrefix] || '07:30 am';
            
            dogIds.forEach((id, index) => {
              if (state.tiles[id]) {
                const dogName = state.tiles[id].text;
                const stopNum = index === 0 ? stopObj.primary : (stopObj.secondary || stopObj.primary);
                
                // Format expected by Google Apps Script
                dogs.push({
                  dogName: dogName,
                  van: VAN_NAMES[vanPrefix],
                  stopNumber: stopNum || '',
                  departureTime: departureTime
                });
              }
            });
          });
          
          if (dogs.length === 0) {
            throw new Error('No dogs to transmit');
          }
          
          const payload = {
            action: 'transmitPlan',
            dogs: dogs,
            departures: departures,
            planType: currentPlan
          };
          
          const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
          });
          
          const result = await res.json();
          
          if (result.success) {
            transmitComplete = true;
            transmitBtn.classList.remove('transmitting');
            transmitBtn.classList.add('success');
            transmitBtn.textContent = '‚úÖ Transmitted!';
            showToast(`Plan transmitted! ${result.count || dogs.length} dogs sent.`, 'success');
          } else {
            throw new Error(result.error || 'Transmit failed');
          }
        } catch (err) {
          transmitBtn.classList.remove('transmitting');
          transmitBtn.disabled = !navigator.onLine;
          transmitBtn.textContent = 'üöÄ Transmit Plan';
          showToast('Transmit failed: ' + err.message, 'error');
        }
      }

      // ==================== PLAN SWITCHING ====================
      function loadPlan(p) {
        currentPlan = p;
        document.getElementById('currentLabel').textContent = p === 'NEXT_AM' ? 'Next AM Plan' : 'PM Plan';
        
        state = { tiles: {}, placements: {}, stops: {}, departures: {} };
        localLoad();
        migrateStopsFormat();
        
        undoStack = [JSON.stringify(state)];
        
        const isNextAM = p === 'NEXT_AM';
        document.body.classList.toggle('next-am-mode', isNextAM);
        
        transmitComplete = false;
        transmitBtn.disabled = false;
        transmitBtn.classList.remove('success', 'transmitting');
        transmitBtn.textContent = 'üöÄ Transmit Plan';
        
        if (state.departures) {
          if (state.departures.bv) document.getElementById('bv-departure').value = state.departures.bv;
          if (state.departures.sv) document.getElementById('sv-departure').value = state.departures.sv;
          if (state.departures.dv) document.getElementById('dv-departure').value = state.departures.dv;
        }
        
        hydrate();
      }
      
      document.querySelectorAll('.departure-selector select').forEach(select => {
        select.addEventListener('change', () => {
          if (currentPlan === 'NEXT_AM') {
            state.departures = {
              bv: document.getElementById('bv-departure').value,
              sv: document.getElementById('sv-departure').value,
              dv: document.getElementById('dv-departure').value
            };
            localSave();
          }
        });
      });

      // ==================== DRAG & DROP ====================
      // Helper functions shared by both approaches
      
      function handleDragEnter(e) {
        e.currentTarget.classList.add('drag-over');
      }
      
      function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
      }
      
      function cleanupDrag() {
        document.body.classList.remove('is-dragging');
        isDragging = false;
        
        document.querySelectorAll('.box, #bin, #tray').forEach(elem => {
          elem.removeEventListener('pointerenter', handleDragEnter);
          elem.removeEventListener('pointerleave', handleDragLeave);
          elem.classList.remove('drag-over');
        });
        
        if (currentDragElement) {
          currentDragElement.style.opacity = '1';
          currentDragElement.classList.remove('long-press-active');
        }
      }
      
      function finishDrag(clientX, clientY) {
        cleanupDrag();
        
        if (activeClone && dragId) {
          const target = document.elementFromPoint(clientX, clientY);
          const box = target?.closest('.box');
          const bin = target?.closest('#bin');
          
          // Remove from all placements
          Object.keys(state.placements).forEach(k => {
            state.placements[k] = state.placements[k].filter(id => id !== dragId);
          });
          
          if (bin) {
            delete state.tiles[dragId];
            showToast('Dog removed', 'info');
          } else if (box) {
            const boxId = box.dataset.box;
            if (!state.placements[boxId]) state.placements[boxId] = [];
            if (state.placements[boxId].length < 2) {
              state.placements[boxId].push(dragId);
            } else {
              showToast('Box is full (max 2 dogs)', 'warning');
            }
          }
          
          activeClone.remove();
          activeClone = null;
          localSave();
          hydrate();
        }
        
        currentDragElement = null;
        dragId = null;
      }
      
      function createDragClone(el, x, y) {
        activeClone = el.cloneNode(true);
        activeClone.classList.add('is-dragging');
        activeClone.style.width = Math.max(el.offsetWidth, 100) + 'px';
        activeClone.style.height = Math.max(el.offsetHeight, 48) + 'px';
        activeClone.style.left = (x - 50) + 'px';
        activeClone.style.top = (y - 24) + 'px';
        document.body.appendChild(activeClone);
        el.style.opacity = '0.3';
      }
      
      function setupDragTargets() {
        document.querySelectorAll('.box').forEach(box => {
          box.addEventListener('pointerenter', handleDragEnter);
          box.addEventListener('pointerleave', handleDragLeave);
        });
        document.getElementById('bin').addEventListener('pointerenter', handleDragEnter);
        document.getElementById('bin').addEventListener('pointerleave', handleDragLeave);
        tray.addEventListener('pointerenter', handleDragEnter);
        tray.addEventListener('pointerleave', handleDragLeave);
      }

      // ==================== POINTER EVENTS (Windows/iOS/Desktop) ====================
      function wirePointerEvents(el, tid) {
        el.onpointerdown = (e) => {
          if (e.button !== 0) return;
          
          startX = e.clientX;
          startY = e.clientY;
          dragId = tid;
          currentDragElement = el;
          el.setPointerCapture(e.pointerId);

          el.onpointermove = (m) => {
            const dist = Math.abs(m.clientX - startX) + Math.abs(m.clientY - startY);
            if (dist > MOVE_THRESHOLD) {
              if (!activeClone) {
                isDragging = true;
                // NOTE: Do NOT add body.is-dragging for pointer events
                // Pointer capture prevents scrolling; body lock causes viewport shrink on Windows
                
                saveUndoState();
                createDragClone(el, m.clientX, m.clientY);
                setupDragTargets();
              }
              activeClone.style.left = (m.clientX - 50) + 'px';
              activeClone.style.top = (m.clientY - 24) + 'px';
            }
          };

          el.onpointerup = (u) => {
            el.releasePointerCapture(u.pointerId);
            el.onpointermove = null;
            el.onpointerup = null;
            
            if (isDragging) {
              finishDrag(u.clientX, u.clientY);
            } else {
              cleanupDrag();
            }
          };
          
          el.onpointercancel = () => {
            cleanupDrag();
            if (activeClone) {
              activeClone.remove();
              activeClone = null;
            }
          };
        };
      }

      // ==================== TOUCH EVENTS (Android only) ====================
      // Android Chrome needs special handling with long-press
      
      // Global touch move handler for Android
      if (isAndroid) {
        document.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          e.preventDefault();
          
          const touch = e.touches[0];
          if (activeClone) {
            activeClone.style.left = (touch.clientX - 50) + 'px';
            activeClone.style.top = (touch.clientY - 24) + 'px';
            
            // Update drag-over states
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            const box = target?.closest('.box');
            const bin = target?.closest('#bin');
            const trayEl = target?.closest('#tray');
            if (box) box.classList.add('drag-over');
            if (bin) bin.classList.add('drag-over');
            if (trayEl) trayEl.classList.add('drag-over');
          }
        }, { passive: false });
        
        document.addEventListener('touchend', (e) => {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          
          if (currentDragElement) {
            currentDragElement.classList.remove('long-press-active');
          }
          
          if (!isDragging) {
            currentDragElement = null;
            return;
          }
          
          const touch = e.changedTouches ? e.changedTouches[0] : null;
          finishDrag(touch ? touch.clientX : 0, touch ? touch.clientY : 0);
        }, { passive: true });
        
        document.addEventListener('touchcancel', () => {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          cleanupDrag();
          if (activeClone) {
            activeClone.remove();
            activeClone = null;
          }
        }, { passive: true });
      }
      
      function wireTouchEvents(el, tid) {
        let touchStartX, touchStartY;
        
        el.addEventListener('touchstart', (e) => {
          if (e.touches.length !== 1) return;
          
          const touch = e.touches[0];
          touchStartX = touch.clientX;
          touchStartY = touch.clientY;
          currentDragElement = el;
          dragId = tid;
          
          // Start long-press timer
          longPressTimer = setTimeout(() => {
            if (currentDragElement === el) {
              el.classList.add('long-press-active');
              
              // Haptic feedback
              if (navigator.vibrate) {
                navigator.vibrate(50);
              }
              
              // Start drag
              isDragging = true;
              document.body.classList.add('is-dragging');
              saveUndoState();
              createDragClone(el, touchStartX, touchStartY);
            }
          }, LONG_PRESS_DELAY);
        }, { passive: true });
        
        el.addEventListener('touchmove', (e) => {
          if (!touchStartX) return;
          
          const touch = e.touches[0];
          const dist = Math.abs(touch.clientX - touchStartX) + Math.abs(touch.clientY - touchStartY);
          
          // Cancel long-press if moved too much
          if (dist > MOVE_THRESHOLD && !isDragging) {
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
            el.classList.remove('long-press-active');
            currentDragElement = null;
            touchStartX = null;
            touchStartY = null;
          }
        }, { passive: true });
        
        el.addEventListener('touchend', () => {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          if (!isDragging) {
            el.classList.remove('long-press-active');
            touchStartX = null;
            touchStartY = null;
          }
        }, { passive: true });
      }

      // ==================== WIRE DRAG EVENTS ====================
      function wireDragEvents(el, tid) {
        if (isAndroid) {
          // Android: Use touch events with long-press
          wireTouchEvents(el, tid);
        } else {
          // Windows/iOS/Desktop: Use pointer events
          wirePointerEvents(el, tid);
        }
        
        // Double-click to edit (works on both)
        el.ondblclick = () => {
          const currentText = state.tiles[tid].text;
          const newText = prompt("Edit dog name:", currentText);
          if (newText && newText.trim() && newText !== currentText) {
            saveUndoState();
            state.tiles[tid].text = newText.trim();
            localSave();
            hydrate();
            showToast('Dog renamed', 'info');
          }
        };
      }

      // ==================== UI RENDERING ====================
      function hydrate() {
        tray.innerHTML = '';
        
        const vanCounts = { bv: 0, sv: 0, dv: 0 };
        
        document.querySelectorAll('.box').forEach(box => {
          const hasWheelArch = box.classList.contains('has-wheel-arch');
          const wheelArchClass = box.dataset.box;
          const boxId = box.dataset.box;
          
          box.innerHTML = '';
          box.classList.remove('full');
          
          if (hasWheelArch) {
            const arch = document.createElement('div');
            arch.className = 'wheel-arch ' + (wheelArchClass === 'sv-b4' ? 'right' : 'left');
            box.appendChild(arch);
          }
          
          const stopObj = getStopObj(boxId);
          const ids = state.placements[boxId] || [];
          
          // Primary stop input
          const stopPrimary = document.createElement('input');
          stopPrimary.className = 'stop-input';
          stopPrimary.type = 'text';
          stopPrimary.maxLength = 3;
          stopPrimary.placeholder = '#';
          stopPrimary.value = stopObj.primary || '';
          stopPrimary.oninput = () => {
            setStopValue(boxId, 'primary', stopPrimary.value);
          };
          box.appendChild(stopPrimary);
          
          // Secondary stop input (only when 2 dogs)
          if (ids.length === 2) {
            const stopSecondary = document.createElement('input');
            stopSecondary.className = 'stop-input-secondary';
            stopSecondary.type = 'text';
            stopSecondary.maxLength = 3;
            stopSecondary.placeholder = '#2';
            stopSecondary.value = stopObj.secondary || '';
            stopSecondary.title = 'Stop number for second dog (leave empty if same as first)';
            stopSecondary.oninput = () => {
              setStopValue(boxId, 'secondary', stopSecondary.value);
            };
            box.appendChild(stopSecondary);
          }
          
          // Inner container
          const inner = document.createElement('div');
          inner.className = 'box-inner';
          box.appendChild(inner);
          
          inner.classList.toggle('two', ids.length === 2);
          
          if (ids.length > 0) {
            box.classList.add('full');
            const vanPrefix = boxId.split('-')[0];
            vanCounts[vanPrefix] += ids.length;
          }
          
          ids.forEach(id => {
            if (state.tiles[id]) {
              const t = document.createElement('div');
              t.className = 'tile-inbox';
              t.textContent = state.tiles[id].text;
              wireDragEvents(t, id);
              inner.appendChild(t);
              requestAnimationFrame(() => fitText(t));
            }
          });
        });
        
        ['bv', 'sv', 'dv'].forEach(van => {
          const countEl = document.getElementById(`${van}-count`);
          if (countEl) {
            const count = vanCounts[van];
            countEl.textContent = `${count} dog${count !== 1 ? 's' : ''}`;
            countEl.classList.toggle('has-dogs', count > 0);
          }
        });
        
        const placed = new Set();
        Object.values(state.placements).forEach(a => a.forEach(id => placed.add(id)));
        
        Object.keys(state.tiles).forEach(id => {
          if (!placed.has(id)) {
            const t = document.createElement('div');
            t.className = 'tile';
            t.textContent = state.tiles[id].text;
            wireDragEvents(t, id);
            tray.appendChild(t);
            requestAnimationFrame(() => fitText(t));
          }
        });
      }

      function fitText(node, isExport = false) {
        if (!node.clientWidth || !node.clientHeight) return;
        
        const maxSize = isExport ? 160 : 100;
        let lo = 10, hi = maxSize, best = 14;
        
        while (lo <= hi) {
          const mid = Math.floor((lo + hi) / 2);
          node.style.fontSize = mid + 'px';
          
          if (node.scrollWidth <= (node.clientWidth - 6) && node.scrollHeight <= (node.clientHeight - 4)) {
            best = mid;
            lo = mid + 1;
          } else {
            hi = mid - 1;
          }
        }
        node.style.fontSize = best + 'px';
      }

      // ==================== EVENT LISTENERS ====================
      document.getElementById('addTileBtn').onclick = () => {
        const text = input.value.trim();
        if (!text) {
          showToast('Please enter a dog name', 'warning');
          input.focus();
          return;
        }
        
        saveUndoState();
        const id = 't_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        state.tiles[id] = { id, text };
        input.value = '';
        localSave();
        hydrate();
        showToast(`Added: ${text}`, 'success');
        input.focus();
      };
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('addTileBtn').click();
        }
      });
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && activeClone) {
          activeClone.remove();
          activeClone = null;
          cleanupDrag();
          undoStack.pop();
        }
      });
      
      shareBtn.onclick = cloudShare;
      fetchBtn.onclick = cloudFetch;
      transmitBtn.onclick = transmitPlan;
      
      clearBtn.onclick = () => {
        if (confirm("Clear all local data for this plan? This cannot be undone.")) {
          state = { tiles: {}, placements: {}, stops: {}, departures: {} };
          undoStack = [JSON.stringify(state)];
          localSave();
          hydrate();
          
          transmitComplete = false;
          transmitBtn.disabled = false;
          transmitBtn.classList.remove('success', 'transmitting');
          transmitBtn.textContent = 'üöÄ Transmit Plan';
          
          showToast('Local data cleared', 'info');
        }
      };
      
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
          tab.classList.add('active');
          loadPlan(tab.dataset.plan);
        };
      });
      
      // ==================== INITIALISATION ====================
      loadPlan('PM');
      
      // Debug: Log which mode is active
      console.log('Drag mode:', isAndroid ? 'Android (touch + long-press)' : 'Pointer events');
      
    })();
  </script>
</body>
</html>
