<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Van Manager - V4</title>
  <style>
    :root { 
      --line: #6d8fb0; 
      --accent: #2c5282; 
      --danger: #e53e3e; 
      --bg: #ffffff; 
      --success: #2f855a;
      --warning: #ed8936;
      --info: #3182ce;
      --secondary: #9f7aea;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --radius: 10px;
    }
    
    * { 
      margin: 0;
      padding: 0;
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }
    
    html {
      overflow-x: hidden;
    }
    
    /* ANDROID FIX: Allow default touch actions on body - MUST be auto */
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
      background: #f6f7f9; 
      min-height: 100vh;
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      touch-action: auto;  /* CRITICAL: Must be auto for Android scroll */
    }
    
    /* ANDROID FIX: No body scroll lock - causes jumps. 
       Touch-action: none on tiles + preventDefault in touchmove handles it */
    body.is-dragging {
      /* Intentionally minimal - no overflow:hidden which causes scroll jump */
    }
    
    /* Navigation Tabs */
    .plan-nav { 
      display: flex; 
      background: #fff; 
      padding: 12px 16px 0; 
      border-bottom: 2px solid #ddd; 
      gap: 6px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    
    .nav-tab { 
      padding: 12px 24px; 
      border: 1px solid #ddd; 
      border-bottom: none; 
      border-radius: 8px 8px 0 0; 
      cursor: pointer; 
      font-weight: 600;
      background: #f8fafc;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .nav-tab:hover:not(.active) { 
      background: #e2e8f0; 
    }
    
    .nav-tab.active { 
      background: var(--accent); 
      color: #fff;
      border-color: var(--accent);
    }
    
    /* Main Layout */
    .page { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 16px; 
      display: grid; 
      gap: 16px; 
    }
    
    /* Top Controls */
    .topbar { 
      background: #fff; 
      border-radius: var(--radius); 
      padding: 16px; 
      display: grid; 
      gap: 12px;
      box-shadow: var(--shadow);
    }
    
    .controls { 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      align-items: center; 
    }
    
    .input-group {
      display: flex;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }
    
    input[type="text"] { 
      flex: 1; 
      padding: 12px 14px; 
      border-radius: 8px; 
      border: 2px solid #e2e8f0; 
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.15);
    }
    
    /* Buttons */
    button { 
      padding: 12px 18px; 
      border-radius: 8px; 
      border: 2px solid transparent; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-primary { 
      background: var(--accent); 
      color: #fff; 
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #1e4072;
    }
    
    .btn-danger { 
      background: #fff5f5; 
      border-color: var(--danger); 
      color: var(--danger); 
    }
    
    .btn-danger:hover:not(:disabled) {
      background: var(--danger);
      color: #fff;
    }
    
    .btn-share { 
      background: #ebf8ff; 
      border-color: var(--info); 
      color: var(--accent); 
    }
    
    .btn-share:hover:not(:disabled) {
      background: var(--info);
      color: #fff;
    }
    
    .btn-fetch { 
      background: #fffaf0; 
      border-color: var(--warning); 
      color: #7b341e; 
    }
    
    .btn-fetch:hover:not(:disabled) {
      background: var(--warning);
      color: #fff;
    }
    
    .btn-transmit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-size: 15px;
    }
    
    .btn-transmit:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-transmit.success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }
    
    .btn-transmit.transmitting {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Tray Area */
    .tray-area { 
      display: flex; 
      gap: 12px; 
      min-height: 90px; 
    }
    
    .tiles-tray { 
      flex: 1; 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      padding: 12px; 
      border: 2px dashed #cbd5e0; 
      border-radius: 8px; 
      background: #f8fafc;
      align-content: flex-start;
      min-height: 80px;
      transition: all 0.2s;
    }
    
    .tiles-tray.drag-over {
      border-color: var(--accent);
      background: #ebf8ff;
    }
    
    .tiles-tray:empty::after {
      content: "Drag dogs here or add new ones above";
      color: #a0aec0;
      font-style: italic;
      align-self: center;
      width: 100%;
      text-align: center;
    }
    
    #bin { 
      width: 80px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: #fed7d7; 
      border: 2px dashed #fc8181; 
      border-radius: 8px; 
      color: #c53030; 
      font-size: 32px;
      transition: all 0.2s;
    }
    
    #bin::after {
      content: "";
    }
    
    #bin.drag-over {
      background: #c53030;
      border-style: solid;
      transform: scale(1.05);
    }
    
    #bin.drag-over::after {
      content: "";
    }
    
    /* Tiles - for Android: touch-action none to enable long-press drag */
    .tile, .tile-inbox { 
      background: #fff; 
      border-radius: 6px; 
      display: flex; 
      align-items: center;
      justify-content: center;
      text-align: center; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      cursor: grab; 
      touch-action: none; /* Enables long-press drag on Android */
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      z-index: 100;
      word-break: break-word; 
      line-height: 1.1; 
      overflow: hidden;
      transition: box-shadow 0.15s ease, border-color 0.15s ease, opacity 0.15s ease;
      font-weight: 500;
    }
    
    /* Touch-active state - immediate feedback when touching tile */
    .tile.touch-active, .tile-inbox.touch-active {
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0.9;
    }
    
    /* Long-press active state - drag is starting */
    .tile.long-press-active, .tile-inbox.long-press-active {
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      opacity: 0.5;
    }
    
    /* Hover states - ONLY for mouse devices */
    @media (hover: hover) and (pointer: fine) {
      .tile:hover, .tile-inbox:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
    }
    
    .tile { 
      min-width: 110px; 
      min-height: 48px; 
      padding: 8px 10px; 
      border: 2px solid #e2e8f0;
    }
    
    .tile-inbox { 
      width: 100%; 
      min-height: 32px;
      padding: 4px 6px;
      border: 1px solid #e2e8f0;
      background: linear-gradient(135deg, #fff 0%, #f7fafc 100%);
    }
    
    /* Layout Cards */
    .layout-card { 
      background: #fff; 
      border-radius: var(--radius); 
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .van-section { 
      margin-bottom: 28px; 
      border-bottom: 2px solid #edf2f7; 
      padding-bottom: 24px; 
    }
    
    .van-section:last-child {
      margin-bottom: 0;
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .card-title { 
      font-weight: 700; 
      margin-bottom: 14px; 
      display: flex; 
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #2d3748;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .dog-count {
      background: #edf2f7;
      color: #4a5568;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .dog-count.has-dogs {
      background: #c6f6d5;
      color: var(--success);
    }
    
    /* Departure Time Selector - Only for NEXT_AM */
    .departure-selector {
      display: none;
      align-items: center;
      gap: 8px;
      background: #f0fff4;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #9ae6b4;
    }
    
    .departure-selector label {
      font-size: 13px;
      font-weight: 600;
      color: #276749;
    }
    
    .departure-selector select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #68d391;
      background: #fff;
      font-size: 13px;
      font-weight: 600;
      color: #276749;
      cursor: pointer;
    }
    
    .departure-selector select:focus {
      outline: none;
      border-color: #38a169;
      box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.3);
    }
    
    body.next-am-mode .departure-selector {
      display: flex;
    }
    
    /* Grid Layouts */
    .two-cols { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px; 
    }
    
    .kennel-grid { 
      border: 2px solid var(--line); 
      background: #fff; 
      display: grid;
      border-radius: 6px;
      overflow: visible;
    }
    
    .box { 
      border: 2px solid var(--line); 
      min-height: 105px; 
      position: relative; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 40px 4px 4px 4px;
      background: #fff;
      transition: all 0.2s;
      overflow: visible;
    }
    
    .box.drag-over {
      background: #ebf8ff;
      border-color: var(--accent);
    }
    
    .box.full {
      background: #f0fff4;
    }
    
    /* Stop Number Inputs */
    .stop-input { 
      position: absolute; 
      top: 3px; 
      left: 3px; 
      width: 50px;
      height: 30px; 
      border: 2px solid #cbd5e0; 
      border-radius: 5px; 
      font-size: 18px; 
      text-align: center; 
      z-index: 5;
      font-weight: 700;
      background: #fff;
      color: #2d3748;
      /* Complete reset */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      box-sizing: border-box;
      padding: 2px 4px;
      margin: 0;
      line-height: 1;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: visible;
      text-overflow: clip;
      white-space: nowrap;
    }
    
    .stop-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(44, 82, 130, 0.2);
    }
    
    /* Secondary stop input - top right, purple border */
    .stop-input-secondary {
      position: absolute;
      top: 3px;
      right: 3px;
      left: auto;
      width: 50px;
      height: 30px;
      border: 2px solid var(--secondary);
      border-radius: 5px;
      font-size: 18px;
      text-align: center;
      z-index: 5;
      font-weight: 700;
      background: #faf5ff;
      color: #553c9a;
      /* Complete reset */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      box-sizing: border-box;
      padding: 2px 4px;
      margin: 0;
      line-height: 1;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: visible;
      text-overflow: clip;
      white-space: nowrap;
    }
    
    .stop-input-secondary:focus {
      outline: none;
      border-color: #805ad5;
      box-shadow: 0 0 0 2px rgba(159, 122, 234, 0.3);
    }
    
    .stop-input-secondary::placeholder {
      color: #b794f4;
    }
    
    .box-inner { 
      width: 100%; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
      pointer-events: auto; 
      justify-content: center;
    }
    
    .box-inner.two {
      gap: 3px;
    }
    
    .box-inner.two .tile-inbox {
      min-height: 28px;
      font-size: 13px;
    }
    
    /* Wheel Arch Styling */
    .box.has-wheel-arch {
      padding-bottom: 32px;
      position: relative;
    }
    
    .wheel-arch {
      position: absolute;
      bottom: 4px;
      width: 50px;
      height: 24px;
      background: #fff;
      border: 2px solid var(--line);
      border-radius: 50px 50px 0 0;
      border-bottom: none;
    }
    
    .wheel-arch.left {
      left: 8px;
    }
    
    .wheel-arch.right {
      right: 8px;
    }
    
    .wheel-arch.center {
      left: 50%;
      transform: translateX(-50%);
    }
    
    /* Dragging State */
    .is-dragging { 
      position: fixed; 
      z-index: 9999 !important; 
      pointer-events: none; 
      opacity: 0.9; 
      transform: scale(1.08) rotate(2deg); 
      box-shadow: 0 15px 35px rgba(0,0,0,0.25);
      /* ADDED: Ensure dragging clone doesn't interfere with touch */
      touch-action: none;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      padding: 14px 20px;
      border-radius: 8px;
      color: #fff;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
      max-width: 320px;
    }
    
    .toast-success { background: var(--success); }
    .toast-error { background: var(--danger); }
    .toast-info { background: var(--info); }
    .toast-warning { background: var(--warning); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; transform: translateX(50%); }
    }
    
    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #718096;
      padding-top: 8px;
      border-top: 1px solid #edf2f7;
      margin-top: 8px;
    }
    
    .status-bar .online-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    
    .status-dot.offline {
      background: var(--danger);
    }
    
    /* Responsive - Tablet */
    @media (max-width: 900px) { 
      .two-cols { grid-template-columns: 1fr; }
      .controls { flex-direction: column; align-items: stretch; }
      .input-group { min-width: 100%; }
      .btn-group { display: flex; flex-wrap: wrap; gap: 8px; }
      .btn-group button { flex: 1; min-width: calc(50% - 4px); }
      .card-title { flex-direction: column; align-items: flex-start; }
    }
    
    /* Responsive - Mobile */
    @media (max-width: 600px) {
      /* Fix horizontal overflow - ONLY on body, let html scroll vertically */
      body {
        overflow-x: hidden;
        width: 100%;
        max-width: 100vw;
      }
      
      .plan-nav { 
        padding: 8px 12px 0; 
        gap: 6px; 
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .nav-tab { 
        padding: 12px 18px; 
        font-size: 14px; 
        flex-shrink: 0;
      }
      
      .page { 
        padding: 10px; 
        gap: 10px;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      .topbar, .layout-card { 
        padding: 12px;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Input stays reasonable */
      input[type="text"] {
        padding: 12px 14px;
        font-size: 16px;
      }
      
      /* Smaller buttons - 2 per row */
      .btn-group { 
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 100%;
      }
      
      .btn-group button { 
        padding: 10px 12px;
        font-size: 13px;
        min-height: 42px;
        width: 100%;
      }
      
      .btn-transmit {
        grid-column: 1 / -1;
        padding: 12px 20px;
        font-size: 15px;
        min-height: 46px;
      }
      
      /* Tray */
      .tray-area { min-height: 100px; }
      .tiles-tray { 
        min-height: 90px; 
        padding: 10px;
        gap: 10px;
      }
      
      /* Tiles */
      .tile { 
        min-width: 90px; 
        min-height: 46px; 
        padding: 8px 10px;
        font-size: 14px;
      }
      
      #bin { 
        width: 70px; 
        font-size: 32px;
      }
      
      /* Kennels */
      .box { 
        min-height: 95px; 
        padding-top: 38px; 
      }
      
      .tile-inbox {
        min-height: 34px;
        padding: 5px 6px;
        font-size: 13px;
      }
      
      .box-inner.two .tile-inbox {
        min-height: 28px;
        font-size: 12px;
      }
      
      /* Stop inputs - KEEP LARGE to prevent clipping */
      .stop-input, .stop-input-secondary { 
        width: 50px !important; 
        height: 30px !important; 
        font-size: 18px !important;
        padding: 2px 4px !important;
      }
      
      /* Van section spacing */
      .van-section {
        margin-bottom: 16px;
        padding-bottom: 16px;
      }
      
      .card-title {
        font-size: 15px;
        gap: 10px;
      }
      
      .dog-count {
        font-size: 12px;
        padding: 4px 10px;
      }
      
      /* Departure selector */
      .departure-selector {
        padding: 6px 10px;
      }
      
      .departure-selector select {
        padding: 8px 10px;
        font-size: 14px;
      }
      
      /* Dispatch Van - stack columns on mobile */
      .van-section[data-van="dv"] > div {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }
      
      .van-section[data-van="dv"] .kennel-grid {
        width: 100%;
      }
      
      /* Make DV extra large box normal height on mobile */
      .van-section[data-van="dv"] .box[data-box="dv-m-xl"] {
        min-height: 95px !important;
      }
      
      /* Status bar */
      .status-bar {
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
        padding-top: 10px;
        margin-top: 10px;
        font-size: 11px;
      }
      
      /* Kennel grid - prevent overflow */
      .kennel-grid {
        max-width: 100%;
      }
      
      .two-cols {
        gap: 12px;
      }
    }
    
    /* Responsive - Small phones */
    @media (max-width: 400px) {
      .plan-nav { padding: 6px 8px 0; }
      .nav-tab { padding: 10px 14px; font-size: 13px; }
      .page { padding: 8px; }
      .topbar, .layout-card { padding: 10px; }
      
      .tile { min-width: 80px; min-height: 42px; }
      .box { min-height: 90px; padding-top: 36px; }
      
      /* Stop inputs - still keep readable */
      .stop-input, .stop-input-secondary { 
        width: 46px !important; 
        height: 28px !important; 
        font-size: 16px !important;
      }
    }
    
    /* Touch device optimisations */
    @media (pointer: coarse) {
      .tile, .tile-inbox {
        cursor: pointer;
      }
      
      /* Prevent text selection */
      .tile, .tile-inbox, .box {
        -webkit-user-select: none;
        user-select: none;
      }
      
      /* NO transform on touch - causes layout thrash per project docs */
      button:active {
        opacity: 0.8;
      }
    }
    
    /* Print Styles */
    @media print {
      body { background: #fff !important; }
      .plan-nav, .topbar, .toast-container { display: none !important; }
      .page { max-width: 100%; padding: 0; }
      .layout-card { box-shadow: none; padding: 10px; }
      .van-section { page-break-inside: avoid; }
      .box { border-width: 1px; }
      .tile-inbox { border: 1px solid #999 !important; }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  
  <div class="plan-nav">
    <div class="nav-tab active" data-plan="PM">üåÜ PM Plan</div>
    <div class="nav-tab" data-plan="NEXT_AM">üìÖ Next Day AM</div>
  </div>
  
  <div class="page">
    <div class="topbar">
      <div class="controls">
        <div class="input-group">
          <input id="tileText" type="text" placeholder="Enter dog name..." maxlength="50" />
          <button id="addTileBtn" type="button" class="btn-primary">+ Add Dog</button>
        </div>
        <div class="btn-group">
          <button id="transmitBtn" class="btn-transmit" title="Transmit plan to Telegram">üöÄ Transmit Plan</button>
          <button id="shareBtn" class="btn-share">‚òÅÔ∏è Share</button>
          <button id="fetchBtn" class="btn-fetch">üì• Fetch</button>
          <button id="clearBtn" class="btn-danger">üóë Clear</button>
        </div>
      </div>
      <div class="tray-area">
        <div class="tiles-tray" id="tray"></div>
        <div id="bin">üóë</div>
      </div>
      <div class="status-bar">
        <div class="online-indicator">
          <span class="status-dot" id="statusDot"></span>
          <span id="onlineStatus">Online</span>
        </div>
        <div id="syncTime">Cloud: Never synced</div>
      </div>
    </div>

    <div class="layout-card" id="printArea">
      
      <div class="van-section" data-van="bv">
        <div class="card-title">
          <span>üöê Big Van (BV)</span>
          <div class="departure-selector" data-van="bv">
            <label>Departs:</label>
            <select id="bv-departure">
              <option value="07:15 am">07:15 am</option>
              <option value="07:30 am" selected>07:30 am</option>
              <option value="08:00 am">08:00 am</option>
              <option value="08:30 am">08:30 am</option>
              <option value="09:00 am">09:00 am</option>
              <option value="09:30 am">09:30 am</option>
            </select>
          </div>
          <span id="currentLabel" style="color: var(--accent);">PM Plan</span>
          <span class="dog-count" id="bv-count">0 dogs</span>
        </div>
        <div class="two-cols">
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)">
              <div class="box" data-box="bv-c1"></div>
              <div class="box" data-box="bv-c2"></div>
              <div class="box" data-box="bv-c3"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="bv-c4"></div>
              <div class="box" data-box="bv-c5"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="bv-c6"></div>
              <div class="box" data-box="bv-c7"></div>
            </div>
          </div>
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)">
              <div class="box" data-box="bv-b1"></div>
              <div class="box" data-box="bv-b2"></div>
              <div class="box" data-box="bv-b3"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(3,1fr)">
              <div class="box" data-box="bv-b4"></div>
              <div class="box" data-box="bv-b5"></div>
              <div class="box" data-box="bv-b6"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="bv-b7"></div>
              <div class="box" data-box="bv-b8"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="van-section" data-van="sv">
        <div class="card-title">
          <span>üöó Small Van (SV)</span>
          <div class="departure-selector" data-van="sv">
            <label>Departs:</label>
            <select id="sv-departure">
              <option value="07:15 am">07:15 am</option>
              <option value="07:30 am" selected>07:30 am</option>
              <option value="08:00 am">08:00 am</option>
              <option value="08:30 am">08:30 am</option>
              <option value="09:00 am">09:00 am</option>
              <option value="09:30 am">09:30 am</option>
            </select>
          </div>
          <span class="dog-count" id="sv-count">0 dogs</span>
        </div>
        <div class="two-cols">
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)">
              <div class="box" data-box="sv-c1"></div>
              <div class="box" data-box="sv-c2"></div>
              <div class="box" data-box="sv-c3"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box" data-box="sv-c4"></div>
              <div class="box" data-box="sv-c5"></div>
            </div>
          </div>
          <div class="kennel-grid">
            <div style="display:grid; grid-template-columns:repeat(3,1fr)">
              <div class="box" data-box="sv-b1"></div>
              <div class="box" data-box="sv-b2"></div>
              <div class="box" data-box="sv-b3"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(2,1fr)">
              <div class="box has-wheel-arch" data-box="sv-b4">
                <div class="wheel-arch right"></div>
              </div>
              <div class="box has-wheel-arch" data-box="sv-b5">
                <div class="wheel-arch left"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="van-section" data-van="dv">
        <div class="card-title">
          <span>üì¶ Dispatch Van (DV)</span>
          <div class="departure-selector" data-van="dv">
            <label>Departs:</label>
            <select id="dv-departure">
              <option value="07:15 am">07:15 am</option>
              <option value="07:30 am">07:30 am</option>
              <option value="08:00 am" selected>08:00 am</option>
              <option value="08:30 am">08:30 am</option>
              <option value="09:00 am">09:00 am</option>
              <option value="09:30 am">09:30 am</option>
            </select>
          </div>
          <span class="dog-count" id="dv-count">0 dogs</span>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 2.2fr 1fr; gap:15px;">
          <div class="kennel-grid">
            <div style="text-align:center; font-size:10px; color:#718096; padding:4px 0; border-bottom:1px solid #e2e8f0;">Passenger</div>
            <div class="box" data-box="dv-l1"></div>
            <div class="box" data-box="dv-l2"></div>
          </div>
          <div class="kennel-grid">
            <div style="text-align:center; font-size:10px; color:#718096; padding:4px 0; border-bottom:1px solid #e2e8f0;">Rear</div>
            <div style="display:grid; grid-template-columns: repeat(3,1fr)">
              <div class="box" data-box="dv-m1"></div>
              <div class="box" data-box="dv-m2"></div>
              <div class="box" data-box="dv-m3"></div>
            </div>
            <div class="box" data-box="dv-m-xl" style="min-height:120px"></div>
          </div>
          <div class="kennel-grid">
            <div style="text-align:center; font-size:10px; color:#718096; padding:4px 0; border-bottom:1px solid #e2e8f0;">Driver</div>
            <div class="box" data-box="dv-r1"></div>
            <div class="box" data-box="dv-r2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // Configuration
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUeIiIJQZZeoo3aXHDdqVZNNqFKLhWhi_WhPVb6GUIvkMlfNxTKsOXyCTGdvAEsMLC/exec';
      const STORAGE_PREFIX = 'van_v5_';  // Updated version for new data structure
      const MAX_UNDO_STATES = 20;
      
      // Valid dog names from JotForm (for validation)
      const VALID_DOG_NAMES = [
        "Aldo","Alfie","April","Argo","Arlo","Banjo","Barney Homewood","Barney Leeming","Baron","Bay","Beano","Bella","Belle","Benson","Betsy","Blue","Bluey","Bo","Bonnie Gallagher","Bonnie Lockwood","Bramble","Branko","Bruce","Bruno","Buddy Dann","Buddy Dargan","Buddy Selby","Casper Hamilton","Casper Kukreja","Che","Chester","Chloe","Clifford","Daisy Cremin","Daisy Parsons","Darcy Campbell","Darcy Dunn","Darwin","Delphine","Dexter","Dicee","Diego Gonsavles","Diego Wojcik","Dierdra","Digby","Dolly","Dottie","Dougie","Dudley","Dusty","Echo","Eddie","Effie","Enzo","Fenton","Ferox","Flaco","Fletcher","Florence","Freddie","Fredo","Frida Walsh","George Elliston","George Jackson","George Mohammed","Gina","Goldie","Haggis","Hattie Campbell","Hattie Duncan","Henry","Holly","Hugo","Incy","Ivy","Jack","Jeff","Jessie","Keti","Kip","Koji","Leo","Lily","Lola Bowles","Lola Fenloni","Lola Hall","Luke","Luna Crockford","Luna Grimshaw","Mac","Macy","Maggie","Margo","Marli","Marloe","Marlow","Martha","Max Tigwell","Merlin Crowley","Merlin Mayne","Miles","Miley","Millie Bowles","Millie Carter","Millie Cartwright","Millie Ellis","Milo McVey","Missy Evans","Mocha Gasper","Mocha Kolumbajew","Mochi","Moka","Mollie","Mos Wan","Moss Harris","Naira","Nala Sands","Nala Warnes","Narla Tester","Ned","Nevis","Nina","Obie","Oliver","Otis","Peggy Gibbons","Peggy Lucas","Pepper","Petch","Pippin","Pluto","Poppy Clark","Poppy Lancaster","Poppy Lass","Poppy Pike","Ralph Goddard","Raven","Reggie Daly","Reggie Foreman","Reggie Russel","Rex","Rita","River","Rocco","Roman","Roxy","Ruby Brooker","Ruby Favell","Ruby Jones","Rudy","Ruffles","Rufus","Rupy","Sam","Sebastian","Shadow Podkalicka","Shadow Wightman","Snoopy","Sonny","Sophie","Stanley James","Star","Storm","Tallulah","Tam","Tasha","Ted Lambie","Teddy Brown","Teddy Jamison","Terry","Tilly Mills","Tokyo","Warwick","Winnie Awele","Winnie Evans","Winnie Hall","Winnie Lancaster","Winnie Ryan","Woody Johns","Woody Warren","Zero","Ziggy"
      ];
      
      // Alias map for common abbreviations
      const DOG_ALIASES = {
        "millie ct": "Millie Cartwright",
        "millie ca": "Millie Carter",
        "millie b": "Millie Bowles",
        "millie e": "Millie Ellis",
        "buddy d": "Buddy Dann",
        "buddy da": "Buddy Dargan",
        "buddy dr": "Buddy Dargan",
        "buddy s": "Buddy Selby",
        "teddy b": "Teddy Brown",
        "teddy j": "Teddy Jamison",
        "missy e": "Missy Evans",
        "milo m": "Milo McVey",
        "luna c": "Luna Crockford",
        "luna g": "Luna Grimshaw",
        "poppy c": "Poppy Clark",
        "poppy l": "Poppy Lancaster",
        "poppy la": "Poppy Lass",
        "poppy p": "Poppy Pike",
        "winnie a": "Winnie Awele",
        "winnie e": "Winnie Evans",
        "winnie h": "Winnie Hall",
        "winnie l": "Winnie Lancaster",
        "winnie r": "Winnie Ryan",
        "woody j": "Woody Johns",
        "woody w": "Woody Warren",
        "ruby b": "Ruby Brooker",
        "ruby f": "Ruby Favell",
        "ruby j": "Ruby Jones",
        "reggie d": "Reggie Daly",
        "reggie f": "Reggie Foreman",
        "reggie r": "Reggie Russel",
        "lola b": "Lola Bowles",
        "lola f": "Lola Fenloni",
        "lola h": "Lola Hall",
        "george e": "George Elliston",
        "george j": "George Jackson",
        "george m": "George Mohammed",
        "daisy c": "Daisy Cremin",
        "daisy p": "Daisy Parsons",
        "darcy c": "Darcy Campbell",
        "darcy d": "Darcy Dunn",
        "hattie c": "Hattie Campbell",
        "hattie d": "Hattie Duncan",
        "casper h": "Casper Hamilton",
        "casper k": "Casper Kukreja",
        "barney h": "Barney Homewood",
        "barney l": "Barney Leeming",
        "bonnie g": "Bonnie Gallagher",
        "bonnie l": "Bonnie Lockwood",
        "diego g": "Diego Gonsavles",
        "diego w": "Diego Wojcik",
        "merlin c": "Merlin Crowley",
        "merlin m": "Merlin Mayne",
        "mocha g": "Mocha Gasper",
        "mocha k": "Mocha Kolumbajew",
        "nala s": "Nala Sands",
        "nala w": "Nala Warnes",
        "peggy g": "Peggy Gibbons",
        "peggy l": "Peggy Lucas",
        "shadow p": "Shadow Podkalicka",
        "shadow w": "Shadow Wightman"
      };
      
      // Van mapping to JotForm values
      const VAN_MAP = {
        'bv': 'Big van - Transit',
        'sv': 'Small van - Renault',
        'dv': 'Dispatch van - Citroen'
      };
      
      // ==================== PLATFORM DETECTION ====================
      const isAndroid = /Android/i.test(navigator.userAgent);
      
      // Shared constants
      const MOVE_THRESHOLD = 10;  // px movement before drag starts (used by Windows pointer events)
      
      // Touch state for drag (used by both platforms)
      let longPressTimer = null;
      let currentDragTile = null;
      
      // DOM Elements
      const tray = document.getElementById('tray');
      const input = document.getElementById('tileText');
      const shareBtn = document.getElementById('shareBtn');
      const fetchBtn = document.getElementById('fetchBtn');
      const clearBtn = document.getElementById('clearBtn');
      const transmitBtn = document.getElementById('transmitBtn');
      const syncTimeEl = document.getElementById('syncTime');
      const statusDot = document.getElementById('statusDot');
      const onlineStatus = document.getElementById('onlineStatus');
      
      // State - Updated structure for dual stop numbers
      let currentPlan = 'PM';
      let state = { tiles: {}, placements: {}, stops: {}, departures: {} };
      // stops structure: { 'bv-c1': { primary: '5', secondary: '3' }, ... }
      
      let undoStack = [];
      let activeClone = null;
      let dragId = null;
      let startX, startY;
      let transmitComplete = false;

      // ==================== TOAST NOTIFICATIONS ====================
      function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // ==================== ONLINE STATUS ====================
      function updateOnlineStatus() {
        const online = navigator.onLine;
        statusDot.classList.toggle('offline', !online);
        onlineStatus.textContent = online ? 'Online' : 'Offline';
        shareBtn.disabled = !online;
        fetchBtn.disabled = !online;
        if (!transmitComplete) {
          transmitBtn.disabled = !online;
        }
      }
      
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();

      // ==================== UNDO FUNCTIONALITY ====================
      function saveUndoState() {
        undoStack.push(JSON.stringify(state));
        if (undoStack.length > MAX_UNDO_STATES) {
          undoStack.shift();
        }
      }

      // ==================== LOCAL STORAGE ====================
      function localSave() { 
        try {
          localStorage.setItem(STORAGE_PREFIX + currentPlan, JSON.stringify(state));
        } catch (e) {
          showToast('Storage full! Please clear some data.', 'error');
        }
      }
      
      // Helper to get stop number object (handles migration from old string format)
      function getStopObj(boxId) {
        const stop = state.stops[boxId];
        if (!stop) return { primary: '', secondary: '' };
        if (typeof stop === 'string') {
          // Migrate old string format to new object format
          return { primary: stop, secondary: '' };
        }
        return stop;
      }
      
      // Helper to set stop number
      function setStopValue(boxId, type, value) {
        if (!state.stops[boxId] || typeof state.stops[boxId] === 'string') {
          const oldValue = typeof state.stops[boxId] === 'string' ? state.stops[boxId] : '';
          state.stops[boxId] = { primary: oldValue, secondary: '' };
        }
        state.stops[boxId][type] = value;
        localSave();
      }

      // ==================== TRANSMIT PLAN ====================
      function findMatchingDogName(inputName) {
        const normalised = inputName.trim().toLowerCase().replace(/\s+/g, ' ');
        const noSpaces = normalised.replace(/\s/g, '');
        
        if (DOG_ALIASES[normalised]) return DOG_ALIASES[normalised];
        
        const aliasMatch = Object.keys(DOG_ALIASES).find(alias => 
          alias.replace(/\s/g, '') === noSpaces
        );
        if (aliasMatch) return DOG_ALIASES[aliasMatch];
        
        const exactMatch = VALID_DOG_NAMES.find(name => 
          name.toLowerCase().replace(/\s+/g, ' ') === normalised
        );
        if (exactMatch) return exactMatch;
        
        const noSpaceMatch = VALID_DOG_NAMES.find(name => 
          name.toLowerCase().replace(/\s/g, '') === noSpaces
        );
        if (noSpaceMatch) return noSpaceMatch;
        
        const startsWithMatch = VALID_DOG_NAMES.find(name => {
          const nameLower = name.toLowerCase().replace(/\s+/g, ' ');
          const nameNoSpaces = name.toLowerCase().replace(/\s/g, '');
          return nameLower.startsWith(normalised) || nameNoSpaces.startsWith(noSpaces);
        });
        if (startsWithMatch) return startsWithMatch;
        
        const parts = normalised.split(' ');
        if (parts.length >= 2) {
          const firstName = parts[0];
          const surnameStart = parts.slice(1).join(' ');
          
          const partialSurnameMatch = VALID_DOG_NAMES.find(name => {
            const nameParts = name.toLowerCase().split(' ');
            if (nameParts.length < 2) return false;
            const nameFirst = nameParts[0];
            const nameSurname = nameParts.slice(1).join(' ');
            return nameFirst === firstName && nameSurname.startsWith(surnameStart);
          });
          if (partialSurnameMatch) return partialSurnameMatch;
        }
        
        const partialMatch = VALID_DOG_NAMES.find(name => {
          const nameLower = name.toLowerCase().replace(/\s+/g, ' ');
          return nameLower.includes(normalised) || normalised.includes(nameLower);
        });
        if (partialMatch) return partialMatch;
        
        return null;
      }
      
      function collectTransmitData() {
        const dogs = [];
        const departures = {
          bv: document.getElementById('bv-departure').value,
          sv: document.getElementById('sv-departure').value,
          dv: document.getElementById('dv-departure').value
        };
        
        // Iterate through all placements
        Object.entries(state.placements).forEach(([boxId, tileIds]) => {
          const stopObj = getStopObj(boxId);
          const primaryStop = stopObj.primary;
          const secondaryStop = stopObj.secondary;
          
          // Skip if no primary stop number assigned
          if (!primaryStop || primaryStop.trim() === '') return;
          
          const vanPrefix = boxId.split('-')[0];
          const vanName = VAN_MAP[vanPrefix];
          const departureTime = departures[vanPrefix];
          
          // Process each dog in the box
          tileIds.forEach((tileId, index) => {
            const tile = state.tiles[tileId];
            if (!tile) return;
            
            const dogName = tile.text;
            const matchedName = findMatchingDogName(dogName);
            
            // Determine stop number:
            // - First dog (index 0, top) uses primary stop
            // - Second dog (index 1, bottom) uses secondary if filled, else primary
            let stopNumber;
            if (index === 0) {
              stopNumber = primaryStop;
            } else {
              // Second dog: use secondary if filled, otherwise use primary (same house)
              stopNumber = (secondaryStop && secondaryStop.trim() !== '') ? secondaryStop : primaryStop;
            }
            
            dogs.push({
              inputName: dogName,
              matchedName: matchedName,
              stopNumber: stopNumber,
              van: vanName,
              departureTime: departureTime,
              isValid: matchedName !== null
            });
          });
        });
        
        return dogs;
      }
      
      async function transmitPlan() {
        if (transmitComplete) {
          showToast('Plan already transmitted. Clear and redo to transmit again.', 'warning');
          return;
        }
        
        const dogs = collectTransmitData();
        
        if (dogs.length === 0) {
          showToast('No dogs with stop numbers to transmit!', 'warning');
          return;
        }
        
        const validDogs = dogs.filter(d => d.isValid);
        const invalidDogs = dogs.filter(d => !d.isValid);
        
        if (validDogs.length === 0) {
          showToast('No valid dogs found in JotForm list!', 'error');
          return;
        }
        
        const departures = {
          bv: document.getElementById('bv-departure').value,
          sv: document.getElementById('sv-departure').value,
          dv: document.getElementById('dv-departure').value
        };
        
        const planLabel = currentPlan === 'NEXT_AM' ? 'Next Day AM' : 'PM';
        const confirmMsg = `Send ${validDogs.length} dogs (${planLabel}) to queue?` + 
          (invalidDogs.length > 0 ? `\n\n‚ö†Ô∏è ${invalidDogs.length} dogs will be skipped (not in list):\n${invalidDogs.map(d => d.inputName).join(', ')}` : '');
        
        if (!confirm(confirmMsg)) return;
        
        transmitBtn.disabled = true;
        transmitBtn.classList.add('transmitting');
        transmitBtn.textContent = 'üîÑ Transmitting...';
        
        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'transmitPlan',
              planType: currentPlan,
              dogs: validDogs.map(d => ({
                dogName: d.matchedName,
                stopNumber: d.stopNumber,
                van: d.van,
                departureTime: d.departureTime,
                status: 'pending'
              })),
              departures: departures,
              timestamp: new Date().toISOString()
            }),
            redirect: 'follow'
          });
          
          const resultText = await response.text();
          console.log('Response:', resultText);
          
          let result;
          try {
            result = JSON.parse(resultText);
          } catch (e) {
            result = { success: true };
          }
          
          if (result.success !== false) {
            transmitComplete = true;
            transmitBtn.classList.remove('transmitting');
            transmitBtn.classList.add('success');
            transmitBtn.textContent = `‚úÖ ${validDogs.length} dogs queued`;
            
            let successMsg = `${planLabel}: ${validDogs.length} dogs added to queue!`;
            if (invalidDogs.length > 0) {
              successMsg += ` (${invalidDogs.length} skipped)`;
            }
            showToast(successMsg, 'success');
            
            if (invalidDogs.length > 0) {
              console.log('Skipped dogs (not in JotForm list):', invalidDogs.map(d => d.inputName));
            }
          } else {
            throw new Error(result.error || 'Unknown error');
          }
          
        } catch (error) {
          console.error('Transmit error:', error);
          transmitBtn.disabled = false;
          transmitBtn.classList.remove('transmitting');
          transmitBtn.textContent = 'üöÄ Transmit Plan';
          showToast(`Failed: ${error.message}`, 'error');
        }
      }

      // ==================== CLOUD OPERATIONS ====================
      async function cloudFetch() {
        fetchBtn.disabled = true;
        fetchBtn.textContent = "üì• Fetching...";
        try {
          const res = await fetch(`${SCRIPT_URL}?planId=${currentPlan}`, {
            method: 'GET',
            cache: 'no-cache',
            redirect: 'follow' 
          });

          if (!res.ok) throw new Error("Network response was not ok");
          const cloud = await res.json();

          if (cloud && cloud.state && cloud.state !== "{}") {
            saveUndoState();
            state = JSON.parse(cloud.state);
            // Migrate old stops format if needed
            migrateStopsFormat();
            syncTimeEl.textContent = `Cloud: ${cloud.time}`;
            localSave();
            hydrate();
            showToast('Plan fetched from cloud!', 'success');
          } else {
            showToast('No cloud data found for this plan.', 'warning');
          }
        } catch(e) { 
          console.error("Fetch Error:", e);
          showToast('Fetch failed. Check your connection.', 'error');
        } finally {
          fetchBtn.disabled = false;
          fetchBtn.textContent = "üì• Fetch";
        }
      }

      async function cloudShare() {
        shareBtn.disabled = true;
        shareBtn.textContent = "‚òÅÔ∏è Sharing...";
        try {
          const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'savePlan', state: state, planId: currentPlan }),
            redirect: 'follow'
          });
          const time = await res.text();
          syncTimeEl.textContent = `Cloud: ${time}`;
          showToast('Plan shared to cloud!', 'success');
        } catch(e) { 
          console.error("Share Error:", e);
          showToast('Share failed. Check permissions.', 'error');
        } finally {
          shareBtn.disabled = false;
          shareBtn.textContent = "‚òÅÔ∏è Share";
        }
      }
      
      // Migrate old string stops to new object format
      function migrateStopsFormat() {
        if (state.stops) {
          Object.keys(state.stops).forEach(boxId => {
            if (typeof state.stops[boxId] === 'string') {
              state.stops[boxId] = { primary: state.stops[boxId], secondary: '' };
            }
          });
        }
      }

      // ==================== PLAN MANAGEMENT ====================
      function loadPlan(p) {
        currentPlan = p;
        document.getElementById('currentLabel').textContent = p.replace('_', ' ') + ' Plan';
        const raw = localStorage.getItem(STORAGE_PREFIX + p);
        state = raw ? JSON.parse(raw) : { tiles: {}, placements: {}, stops: {}, departures: {} };
        
        // Migrate old stops format
        migrateStopsFormat();
        
        undoStack = [JSON.stringify(state)];
        
        const isNextAM = p === 'NEXT_AM';
        document.body.classList.toggle('next-am-mode', isNextAM);
        
        transmitComplete = false;
        transmitBtn.disabled = false;
        transmitBtn.classList.remove('success', 'transmitting');
        transmitBtn.textContent = 'üöÄ Transmit Plan';
        
        if (state.departures) {
          if (state.departures.bv) document.getElementById('bv-departure').value = state.departures.bv;
          if (state.departures.sv) document.getElementById('sv-departure').value = state.departures.sv;
          if (state.departures.dv) document.getElementById('dv-departure').value = state.departures.dv;
        }
        
        hydrate();
      }
      
      document.querySelectorAll('.departure-selector select').forEach(select => {
        select.addEventListener('change', () => {
          if (currentPlan === 'NEXT_AM') {
            state.departures = {
              bv: document.getElementById('bv-departure').value,
              sv: document.getElementById('sv-departure').value,
              dv: document.getElementById('dv-departure').value
            };
            localSave();
          }
        });
      });

      // ==================== DRAG & DROP ====================
      let isDragging = false;
      
      // ==================== ANDROID TOUCH HANDLING ====================
      // PATTERN FROM WORKING TEMPLATE: Document-level event delegation
      // 1. Single touchstart listener on document
      // 2. Passive touchmove to detect scrolling
      // 3. Non-passive touchmove ONLY during active drag
      
      // State for touch drag
      let touchStartPos = null;
      let dragSourceElement = null;
      let pendingDragInfo = null;
      let boundTouchMove = null;
      let boundTouchEnd = null;
      
      // Settings - TUNED for responsiveness
      const LONG_PRESS_DURATION = 180;  // Reduced from 300ms for faster response
      const SCROLL_THRESHOLD = 10;      // Slightly higher to reduce accidental cancels
      
      // Store touch offset for smooth drag positioning
      let touchOffsetX = 0;
      let touchOffsetY = 0;
      
      // Handle touch start - DOCUMENT LEVEL
      function handleTouchStart(e) {
        if (e.touches.length !== 1) return; // Single touch only
        
        const touch = e.touches[0];
        // Find tile directly (entire tile is now draggable)
        const tile = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.tile, .tile-inbox');
        if (!tile) return;
        
        // Get tile ID from data attribute
        const tid = tile.getAttribute('data-tile-id');
        if (!tid || !state.tiles[tid]) return;
        
        // Clean up any existing listeners first (prevents stacking)
        document.removeEventListener('touchmove', checkTouchScroll);
        document.removeEventListener('touchend', cancelTouchDrag);
        document.removeEventListener('touchcancel', cancelTouchDrag);
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
        
        // Calculate offset from touch point to tile top-left (for smooth positioning)
        const tileRect = tile.getBoundingClientRect();
        touchOffsetX = touch.clientX - tileRect.left;
        touchOffsetY = touch.clientY - tileRect.top;
        
        touchStartPos = { x: touch.clientX, y: touch.clientY };
        dragSourceElement = tile;
        pendingDragInfo = {
          tile: tile,
          tid: tid,
          coords: { x: touch.clientX, y: touch.clientY }
        };
        
        // Immediate visual feedback
        tile.classList.add('touch-active');
        
        // Start long-press timer
        longPressTimer = setTimeout(() => {
          if (pendingDragInfo && touchStartPos) {
            startDragTouch(pendingDragInfo);
          }
        }, LONG_PRESS_DURATION);
        
        // Listen for movement/cancel (passive to allow scroll initially)
        document.addEventListener('touchmove', checkTouchScroll, { passive: true });
        document.addEventListener('touchend', cancelTouchDrag);
        document.addEventListener('touchcancel', cancelTouchDrag);
      }
      
      // Check if user is scrolling (passive - doesn't block scroll)
      function checkTouchScroll(e) {
        if (!touchStartPos || isDragging) return;
        
        const touch = e.touches[0];
        const dx = Math.abs(touch.clientX - touchStartPos.x);
        const dy = Math.abs(touch.clientY - touchStartPos.y);
        
        // If moved too much before timer, it's a scroll - cancel drag
        if (dx > SCROLL_THRESHOLD || dy > SCROLL_THRESHOLD) {
          cancelTouchDrag();
        }
      }
      
      // Cancel drag attempt (user scrolled or lifted finger)
      function cancelTouchDrag() {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
        
        // Remove visual feedback
        if (dragSourceElement) {
          dragSourceElement.classList.remove('touch-active');
        }
        
        touchStartPos = null;
        pendingDragInfo = null;
        dragSourceElement = null;
        
        document.removeEventListener('touchmove', checkTouchScroll);
        document.removeEventListener('touchend', cancelTouchDrag);
        document.removeEventListener('touchcancel', cancelTouchDrag);
      }
      
      // Start actual drag (long-press completed)
      function startDragTouch(dragInfo) {
        // Remove the scroll-checking listeners
        document.removeEventListener('touchmove', checkTouchScroll);
        document.removeEventListener('touchend', cancelTouchDrag);
        document.removeEventListener('touchcancel', cancelTouchDrag);
        
        // Now we're dragging
        isDragging = true;
        dragId = dragInfo.tid;
        currentDragTile = dragInfo.tile;
        
        // Lock body scroll
        document.body.classList.add('is-dragging');
        
        // Haptic feedback
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
        
        // Visual feedback - transition from touch-active to long-press-active
        if (dragSourceElement) {
          dragSourceElement.classList.remove('touch-active');
          dragSourceElement.classList.add('long-press-active');
        }
        
        // Save undo state and create ghost
        saveUndoState();
        createDragClone(dragInfo.tile, dragInfo.coords.x, dragInfo.coords.y);
        
        // CRITICAL: Add NON-PASSIVE touchmove listener to block scrolling
        boundTouchMove = handleDragTouchMove;
        boundTouchEnd = handleDragTouchEnd;
        document.addEventListener('touchmove', boundTouchMove, { passive: false });
        document.addEventListener('touchend', boundTouchEnd);
        document.addEventListener('touchcancel', boundTouchEnd);
      }
      
      // Handle touch move DURING DRAG (non-passive)
      function handleDragTouchMove(e) {
        if (!isDragging) return;
        
        // CRITICAL: Prevent default to STOP scrolling
        e.preventDefault();
        
        const touch = e.touches[0];
        
        if (activeClone) {
          // Position clone relative to finger using saved offset
          activeClone.style.left = (touch.clientX - touchOffsetX) + 'px';
          activeClone.style.top = (touch.clientY - touchOffsetY) + 'px';
        }
        
        // Update drag-over states
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        if (target) {
          const box = target.closest('.box');
          const bin = target.closest('#bin');
          const trayEl = target.closest('#tray');
          if (box) box.classList.add('drag-over');
          if (bin) bin.classList.add('drag-over');
          if (trayEl) trayEl.classList.add('drag-over');
        }
      }
      
      // Handle touch end DURING DRAG
      function handleDragTouchEnd(e) {
        // Remove listeners
        document.removeEventListener('touchmove', boundTouchMove);
        document.removeEventListener('touchend', boundTouchEnd);
        document.removeEventListener('touchcancel', boundTouchEnd);
        
        // Get final position
        const touch = e.changedTouches[0];
        const finalX = touch.clientX;
        const finalY = touch.clientY;
        
        // Clean up and process drop
        finishDrag(finalX, finalY);
      }
      
      // Setup Android touch events - DOCUMENT LEVEL
      if (isAndroid) {
        document.addEventListener('touchstart', handleTouchStart, { passive: true });
      }
      
      // ==================== HELPER FUNCTIONS ====================
      
      function createDragClone(tile, x, y) {
        activeClone = tile.cloneNode(true);
        activeClone.classList.add('is-dragging');
        activeClone.classList.remove('touch-active', 'long-press-active');
        activeClone.style.width = Math.max(tile.offsetWidth, 100) + 'px';
        activeClone.style.height = Math.max(tile.offsetHeight, 48) + 'px';
        // Position using saved offset so clone appears exactly where finger is
        activeClone.style.left = (x - touchOffsetX) + 'px';
        activeClone.style.top = (y - touchOffsetY) + 'px';
        document.body.appendChild(activeClone);
        tile.style.opacity = '0.3';
      }
      
      function finishDrag(clientX, clientY) {
        document.body.classList.remove('is-dragging');
        isDragging = false;
        
        // Clean up visual feedback
        if (dragSourceElement) {
          dragSourceElement.classList.remove('touch-active', 'long-press-active');
          dragSourceElement.style.opacity = '1';
        }
        if (currentDragTile) {
          currentDragTile.style.opacity = '1';
        }
        
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        
        if (activeClone && dragId) {
          const target = document.elementFromPoint(clientX, clientY);
          const box = target?.closest('.box');
          const bin = target?.closest('#bin');
          
          // Remove from all placements
          Object.keys(state.placements).forEach(k => {
            state.placements[k] = state.placements[k].filter(id => id !== dragId);
          });
          
          if (bin) {
            delete state.tiles[dragId];
            showToast('Dog removed', 'info');
          } else if (box) {
            const boxId = box.dataset.box;
            if (!state.placements[boxId]) state.placements[boxId] = [];
            if (state.placements[boxId].length < 2) {
              state.placements[boxId].push(dragId);
            } else {
              showToast('Box is full (max 2 dogs)', 'warning');
            }
          }
          
          activeClone.remove();
          activeClone = null;
          localSave();
          hydrate();
        }
        
        // Reset all drag state
        currentDragTile = null;
        dragSourceElement = null;
        pendingDragInfo = null;
        touchStartPos = null;
        dragId = null;
      }
      
      function cancelDrag() {
        document.body.classList.remove('is-dragging');
        isDragging = false;
        
        // Clean up visual feedback
        if (dragSourceElement) {
          dragSourceElement.classList.remove('touch-active', 'long-press-active');
          dragSourceElement.style.opacity = '1';
        }
        if (currentDragTile) {
          currentDragTile.style.opacity = '1';
        }
        
        if (activeClone) {
          activeClone.remove();
          activeClone = null;
        }
        
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        
        // Reset all drag state
        currentDragTile = null;
        dragSourceElement = null;
        pendingDragInfo = null;
        touchStartPos = null;
        dragId = null;
      }
      
      // ==================== WINDOWS/DESKTOP: Pointer events on WHOLE TILE ====================
      
      function wirePointerEvents(tile, tid) {
        // Set touch-action: none on tile for pointer capture to work
        tile.style.touchAction = 'none';
        
        tile.onpointerdown = function(e) {
          if (e.button !== 0) return;
          
          startX = e.clientX;
          startY = e.clientY;
          dragId = tid;
          currentDragTile = tile;
          
          // Calculate offset for smooth positioning
          const tileRect = tile.getBoundingClientRect();
          touchOffsetX = e.clientX - tileRect.left;
          touchOffsetY = e.clientY - tileRect.top;
          
          tile.setPointerCapture(e.pointerId);

          tile.onpointermove = function(m) {
            const dist = Math.abs(m.clientX - startX) + Math.abs(m.clientY - startY);
            if (dist > MOVE_THRESHOLD) {
              if (!activeClone) {
                isDragging = true;
                saveUndoState();
                createDragClone(tile, m.clientX, m.clientY);
              }
              // Use offset for smooth positioning
              activeClone.style.left = (m.clientX - touchOffsetX) + 'px';
              activeClone.style.top = (m.clientY - touchOffsetY) + 'px';
              
              // Update drag-over states
              document.querySelectorAll('.drag-over').forEach(elem => elem.classList.remove('drag-over'));
              const target = document.elementFromPoint(m.clientX, m.clientY);
              if (target) {
                const box = target.closest('.box');
                const bin = target.closest('#bin');
                const trayEl = target.closest('#tray');
                if (box) box.classList.add('drag-over');
                if (bin) bin.classList.add('drag-over');
                if (trayEl) trayEl.classList.add('drag-over');
              }
            }
          };

          tile.onpointerup = function(u) {
            tile.releasePointerCapture(u.pointerId);
            tile.onpointermove = null;
            tile.onpointerup = null;
            
            if (isDragging) {
              finishDrag(u.clientX, u.clientY);
            } else {
              tile.style.opacity = '1';
              currentDragTile = null;
            }
          };
          
          tile.onpointercancel = function() {
            cancelDrag();
          };
        };
      }
      
      // ==================== CREATE TILE (Full tile draggable) ====================
      
      function createTileElement(tid, className) {
        const tile = document.createElement('div');
        tile.className = className;
        tile.textContent = state.tiles[tid].text;
        
        if (isAndroid) {
          // ANDROID: Mark tile as draggable (whole tile is draggable via long-press)
          tile.setAttribute('data-tile-id', tid);
          // Touch events handled at document level
        } else {
          // WINDOWS/DESKTOP: Pointer events on whole tile
          wirePointerEvents(tile, tid);
        }
        
        // Double-click to edit (on whole tile)
        tile.ondblclick = function() {
          const currentText = state.tiles[tid].text;
          const newText = prompt("Edit dog name:", currentText);
          if (newText && newText.trim() && newText !== currentText) {
            saveUndoState();
            state.tiles[tid].text = newText.trim();
            localSave();
            hydrate();
            showToast('Dog renamed', 'info');
          }
        };
        
        return tile;
      }
      
      function handleDragEnter(e) {
        e.currentTarget.classList.add('drag-over');
      }
      
      function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
      }

      // ==================== UI RENDERING ====================
      function hydrate() {
        tray.innerHTML = '';
        
        const vanCounts = { bv: 0, sv: 0, dv: 0 };
        
        document.querySelectorAll('.box').forEach(box => {
          const hasWheelArch = box.classList.contains('has-wheel-arch');
          const wheelArchClass = box.dataset.box;
          const boxId = box.dataset.box;
          
          box.innerHTML = '';
          box.classList.remove('full');
          
          if (hasWheelArch) {
            const arch = document.createElement('div');
            arch.className = 'wheel-arch ' + (wheelArchClass === 'sv-b4' ? 'right' : 'left');
            box.appendChild(arch);
          }
          
          const stopObj = getStopObj(boxId);
          const ids = state.placements[boxId] || [];
          
          // Primary stop input (top left) - always visible
          const stopPrimary = document.createElement('input');
          stopPrimary.className = 'stop-input';
          stopPrimary.type = 'text';
          stopPrimary.maxLength = 3;
          stopPrimary.placeholder = '#';
          stopPrimary.value = stopObj.primary || '';
          stopPrimary.oninput = () => {
            setStopValue(boxId, 'primary', stopPrimary.value);
          };
          box.appendChild(stopPrimary);
          
          // Secondary stop input (top right) - only show when 2 dogs in kennel
          if (ids.length === 2) {
            const stopSecondary = document.createElement('input');
            stopSecondary.className = 'stop-input-secondary';
            stopSecondary.type = 'text';
            stopSecondary.maxLength = 3;
            stopSecondary.placeholder = '#2';
            stopSecondary.value = stopObj.secondary || '';
            stopSecondary.title = 'Stop number for second dog (leave empty if same as first)';
            stopSecondary.oninput = () => {
              setStopValue(boxId, 'secondary', stopSecondary.value);
            };
            box.appendChild(stopSecondary);
          }
          
          // Inner container
          const inner = document.createElement('div');
          inner.className = 'box-inner';
          box.appendChild(inner);
          
          inner.classList.toggle('two', ids.length === 2);
          
          if (ids.length > 0) {
            box.classList.add('full');
            const vanPrefix = boxId.split('-')[0];
            vanCounts[vanPrefix] += ids.length;
          }
          
          ids.forEach(id => {
            if (state.tiles[id]) {
              const t = createTileElement(id, 'tile-inbox');
              inner.appendChild(t);
              // fitText: use text span on Android, whole tile on Windows
              const textEl = t.querySelector('.tile-text') || t;
              requestAnimationFrame(() => fitText(textEl));
            }
          });
        });
        
        ['bv', 'sv', 'dv'].forEach(van => {
          const countEl = document.getElementById(`${van}-count`);
          if (countEl) {
            const count = vanCounts[van];
            countEl.textContent = `${count} dog${count !== 1 ? 's' : ''}`;
            countEl.classList.toggle('has-dogs', count > 0);
          }
        });
        
        const placed = new Set();
        Object.values(state.placements).forEach(a => a.forEach(id => placed.add(id)));
        
        Object.keys(state.tiles).forEach(id => {
          if (!placed.has(id)) {
            const t = createTileElement(id, 'tile');
            tray.appendChild(t);
            // fitText: use text span on Android, whole tile on Windows
            const textEl = t.querySelector('.tile-text') || t;
            requestAnimationFrame(() => fitText(textEl));
          }
        });
      }

      function fitText(node, isExport = false) {
        if (!node.clientWidth || !node.clientHeight) return;
        
        const maxSize = isExport ? 160 : 100;
        let lo = 10, hi = maxSize, best = 14;
        
        while (lo <= hi) {
          const mid = Math.floor((lo + hi) / 2);
          node.style.fontSize = mid + 'px';
          
          if (node.scrollWidth <= (node.clientWidth - 6) && node.scrollHeight <= (node.clientHeight - 4)) {
            best = mid;
            lo = mid + 1;
          } else {
            hi = mid - 1;
          }
        }
        node.style.fontSize = best + 'px';
      }

      // ==================== EVENT LISTENERS ====================
      document.getElementById('addTileBtn').onclick = () => {
        const text = input.value.trim();
        if (!text) {
          showToast('Please enter a dog name', 'warning');
          input.focus();
          return;
        }
        
        saveUndoState();
        const id = 't_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        state.tiles[id] = { id, text };
        input.value = '';
        localSave();
        hydrate();
        showToast(`Added: ${text}`, 'success');
        input.focus();
      };
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('addTileBtn').click();
        }
      });
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && activeClone) {
          activeClone.remove();
          activeClone = null;
          document.querySelectorAll('[style*="opacity: 0.3"]').forEach(el => {
            el.style.opacity = '1';
          });
          document.querySelectorAll('.drag-over').forEach(el => {
            el.classList.remove('drag-over');
          });
          undoStack.pop();
        }
      });
      
      shareBtn.onclick = cloudShare;
      fetchBtn.onclick = cloudFetch;
      transmitBtn.onclick = transmitPlan;
      
      clearBtn.onclick = () => {
        if (confirm("Clear all local data for this plan? This cannot be undone.")) {
          state = { tiles: {}, placements: {}, stops: {}, departures: {} };
          undoStack = [JSON.stringify(state)];
          localSave();
          hydrate();
          
          transmitComplete = false;
          transmitBtn.disabled = false;
          transmitBtn.classList.remove('success', 'transmitting');
          transmitBtn.textContent = 'üöÄ Transmit Plan';
          
          showToast('Local data cleared', 'info');
        }
      };
      
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
          tab.classList.add('active');
          loadPlan(tab.dataset.plan);
        };
      });
      
      // ==================== INITIALISATION ====================
      loadPlan('PM');
      
      // Debug logging
      console.log('=== Van Manager - Full Tile Drag ===');
      console.log('User Agent:', navigator.userAgent);
      console.log('isAndroid:', isAndroid);
      if (isAndroid) {
        console.log('Mode: ANDROID - Full tile long-press drag');
        console.log('- Long-press tile for 180ms to start drag');
        console.log('- Tile has touch-action: none (no scroll on tile)');
        console.log('- Scroll by touching areas outside tiles');
        console.log('- Clone positioned relative to finger touch point');
      } else {
        console.log('Mode: WINDOWS/DESKTOP');
        console.log('- Drag: Touch/click anywhere on tile');
      }
      
    })();
  </script>
</body>
</html>
